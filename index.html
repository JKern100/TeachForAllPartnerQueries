<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Teach For All — Knowledge Q&A</title>
  <style>
  
  /* ---- visual polish only; no JS affected ---- */

  /* Answer typography */
  #answer, #ans {
    line-height: 1.6;
    font-size: 15.5px;
  }
  #answer h2, #answer h3, #answer h4,
  #ans h2,    #ans h3,    #ans h4 {
    margin: 0.5rem 0 0.25rem;
    font-weight: 600;
    letter-spacing: .1px;
  }
  #answer p, #ans p {
    margin: 0.4rem 0 0.75rem;
  }
  #answer ul, #answer ol,
  #ans ul,    #ans ol {
    margin: 0.5rem 0 0.9rem 1.15rem;
  }
  #answer li, #ans li {
    margin: 0.2rem 0;
  }

  /* Error + debug readability (does not change logic) */
  #error, #err {
    color: #ff6b6b;
    font-weight: 500;
  }
  #debug, #dbg {
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    font-size: 12px;
    color: #aab2c0;
    white-space: pre-wrap;
  }

  /* Quick ranges: lighter labels and clearer hover */
  /* If your wrapper has a different class/id, replace .quick with that container */
  .quick button, .quick .btn, .quick-ranges .btn {
    background: #1a1f2b;
    color: #c9d2e3;
    border: 1px solid #2b3343;
    padding: 6px 10px;
    border-radius: 8px;
    transition: background .12s ease, border-color .12s ease, color .12s ease;
  }
  .quick button:hover, .quick .btn:hover, .quick-ranges .btn:hover {
    background: #222836;
    border-color: #3b455a;
    color: #e8eefc;
  }

  /* Save-note section spacing only (no functional change) */
  .note-panel .hint {
    color: #aab2c0;
    font-size: 13px;
  }

  
    :root {
      --bg: #0f1220;
      --panel: #171a2a;
      --text: #e9ecff;
      --muted: #9aa3c7;
      --accent: #7aa2ff;
      --accent-2: #a8ffef;
      --danger: #ff7a7a;
      --ok: #6ee7b7;
      --border: #232743;
    }
    html, body { background: var(--bg); color: var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
    .wrap { max-width: 1050px; margin: 32px auto 120px; padding: 0 16px; }
    h1 { font-size: 26px; margin: 0 0 20px; letter-spacing: .2px }
    .subtle { color: var(--muted); font-size: 12px; margin-left: 8px; padding: 2px 6px; background: #1e2238; border-radius: 10px; vertical-align: middle;}
    .card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 18px; margin-bottom: 16px; }
    label { display:block; font-size: 12px; color: var(--muted); margin: 14px 0 6px; }
    input[type="text"], input[type="date"], select, textarea {
      width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); background: #0f1330; color: var(--text);
    }
    textarea { min-height: 120px; resize: vertical; }
    .row { display:flex; gap:14px; }
    .row > div { flex:1; }
    .row-3 > div { flex: 1 1 33.3%; }
    .btns { display:flex; gap:10px; margin-top: 14px; }
    button {
      padding: 10px 14px; border-radius: 8px; border: 1px solid var(--border);
      background: #1e2448; color: var(--text); cursor: pointer;
    }
    button.primary { background: #2a3470; border-color:#384196; }
    button:disabled { opacity: .6; cursor: default; }
    .muted { color: var(--muted); }
    .answer { background: #0e1233; border: 1px solid var(--border); border-radius: 10px; padding: 16px; min-height: 80px }
    .error { color: var(--danger); }
    details summary { cursor:pointer; color: var(--muted); }
    ul.clean { margin: 6px 0 0 18px; }
    .tag { display:inline-block; font-size: 12px; padding: 2px 8px; border:1px solid var(--border); border-radius: 999px; color: var(--muted); margin-right:6px;}
/* ---- Layout guardrails (add at the END of your <style>) ---- */

/* 1) Make sizing predictable everywhere */
*, *::before, *::after { box-sizing: border-box; }
html, body { overflow-x: hidden; }

/* 2) Keep the page centered and inside a max width */
.wrap { max-width: 1100px; margin: 32px auto; padding-inline: 16px; }

/* 3) Cards never let children bleed out */
.card { overflow: hidden; }

/* 4) Form controls always fit their container */
input[type="text"],
input[type="date"],
select,
textarea,
button {
  width: 100%;
  max-width: 100%;
  min-width: 0;          /* <— fixes flex/grid overflow */
  display: block;
}

/* 5) Textarea sizing & scrolling (no boundary spill) */
textarea {
  resize: vertical;
  min-height: 140px;
  overflow: auto;
}

/* 6) Shared row helpers: wrap instead of pushing out */
.row { display: flex; flex-wrap: wrap; gap: 14px; }
.row > div { flex: 1 1 280px; min-width: 240px; }

/* 7) Quick ranges: wrap buttons on smaller widths */
.quick, .quick-ranges {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 8px;
}

/* 8) Small screens: stack everything safely */
@media (max-width: 900px) {
  .wrap { padding-inline: 12px; }
  .row > div { flex-basis: 100%; min-width: 0; }
}
/* Busy indicator (safe visual-only) */
.busy {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-top: 10px;
  color: var(--muted);
}
.busy[hidden] { display: none; }

.spinner {
  width: 16px;
  height: 16px;
  border: 2px solid transparent;
  border-top-color: #8fb1ff;
  border-right-color: #8fb1ff;
  border-radius: 50%;
  animation: spin .8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Subtle disabled look for buttons while busy */
button:disabled { opacity: .6; cursor: default; }

  </style>
</head>
<body>
  <div class="wrap">

    <h1>Teach For All — Knowledge Q&amp;A <span class="subtle">V21</span></h1>

    <div class="card">
      <div class="row row-3">
        <div>
          <label>From date</label>
          <input id="from" type="date" />
        </div>
        <div>
          <label>To date</label>
          <input id="to" type="date" />
        </div>
        <div>
          <label>Quick ranges</label>
          <div class="btns">
            <button onclick="qrange(7)">Past 7 days</button>
            <button onclick="qrange(31)">Past month</button>
            <button onclick="qrange(92)">Last 3 months</button>
            <button onclick="clearDates()">Clear dates</button>
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Type</label>
          <select id="type">
            <option value="all">All (default)</option>
            <option value="Zoom Meeting">Zoom Meeting</option>
            <option value="Email">Email</option>
            <option value="Note">Note</option>
          </select>
        </div>
        <div>
          <label>Countries (comma-separated)</label>
          <input id="countries" type="text" placeholder="e.g., Portugal, Spain" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Topic (optional)</label>
          <input id="topic" type="text" placeholder="standards, onboarding, budget…" />
        </div>
        <div>
          <label>Response speed</label>
          <select id="speed">
            <option value="30">Fast (~30 rows)</option>
            <option value="100" selected>Medium (~100 rows)</option>
            <option value="300">Max (300 rows)</option>
          </select>
        </div>
      </div>

      <label>Question</label>
      <textarea id="question" placeholder="Ask your question… e.g., What was my last meeting with Bea about?"></textarea>

      <div class="row">
        <div>
          <label>Answer style</label>
          <select id="style">
            <option value="normal" selected>normal</option>
            <option value="short">short</option>
          </select>
        </div>
      </div>

      <div class="btns">
        <button id="askBtn" class="primary" onclick="ask()">Ask</button>
        <button onclick="resetForm()">Reset</button>
      </div>
    </div>
    <!-- Busy indicator (hidden by default) -->
    <div id="busy" class="busy" hidden aria-live="polite">
        <span class="spinner"></span>
        <span id="busyText">Working…</span>
    </div>



    <div class="card">
      <h3 style="margin:0 0 10px">Answer</h3>
      <div id="answer" class="answer"></div>
      <div id="err" class="error" style="margin-top:8px;"></div>

      <details style="margin-top:14px">
        <summary>Debug — Request, REST, SQL, Prompt &amp; Raw JSON</summary>
        <div id="debug" class="muted" style="white-space:pre-wrap; font-size:12px; margin-top:10px;"></div>
      </details>
    </div>

    <div class="card">
      <h3 style="margin:0 0 6px">Sources</h3>
      <div id="sources" class="muted"></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px">Add Note to Supabase</h3>
      <label>Note text</label>
      <textarea id="note" placeholder="Write a quick note to save…"></textarea>
      <div class="row">
        <div>
          <label for="note_headline">Headline (optional)</label>
          <input id="note_headline" type="text" placeholder="e.g., Dev Community call — key decisions" />
          <label>Optional: Meeting ID</label>
          <input id="meeting_id" type="text" placeholder="e.g., r1" />
        </div>
        <div>
          <label>Optional: Author</label>
          <input id="author" type="text" placeholder="Your name or email" />
        </div>
      </div>
      <div class="btns">
        <button id="saveNoteBtn" class="primary" onclick="saveNote()">Save note</button>
        <span class="muted">Tip: filters, dates, and question are saved in <code>meta</code>.</span>
      </div>
      <div id="noteMsg" class="muted" style="margin-top:8px;"></div>
    </div>
  </div>

  <!-- === Transcript search (new) === -->
<div class="card" id="tr_card">
  <h3 style="margin:0 0 8px">Transcript query</h3>

  <div class="row">
    <div>
      <label>From (transcripts)</label>
      <input id="tr_from" type="date" />
    </div>
    <div>
      <label>To</label>
      <input id="tr_to" type="date" />
    </div>
  </div>

  <label>Keywords (file name or contents)</label>
  <input id="tr_kw" type="text" placeholder="e.g., Portugal, Tiago, budget" />

  <div class="btns">
    <button id="trFindBtn" class="primary" onclick="findTranscripts()">Find transcripts</button>
  </div>

  <div id="tr_results" class="muted" style="margin-top:10px;"></div>
</div>

<!-- === Transcript Q&A (new) === -->
<div class="card" id="tr_qa" hidden>
  <h3 style="margin:0 0 8px">Ask about selected transcript</h3>
  <div id="tr_meta" class="muted"></div>

  <pre id="tr_preview"
       style="white-space:pre-wrap;background:#0e1233;padding:12px;border-radius:8px;border:1px solid var(--border);max-height:200px;overflow:auto;margin-top:8px;"></pre>

  <label>Question about this transcript</label>
  <textarea id="tr_q" placeholder="Ask a question about the selected transcript…"></textarea>

  <div class="btns">
    <button id="trAskBtn" class="primary" onclick="askTranscript()">Ask about transcript</button>
  </div>

  <div id="tr_ans" class="answer" style="margin-top:10px;"></div>
  <div id="tr_err" class="error" style="margin-top:8px;"></div>
</div>


  <script>
    // ========= CONFIG =========
    const GAS_BASE = "https://script.google.com/macros/s/AKfycbyvzIgN1uiRtnQh9SkjHo8ADtm66NrX2b1uIWr_vQ6XweQZvu1r9izXIVtPWzF7SuDZ/exec"; // <-- replace if you redeploy

    // ========= JSONP =========
    function jsonp(baseUrl, params, timeoutMs = 60000) {
      return new Promise((resolve, reject) => {
        const cbName = "__cb" + Date.now() + "_" + Math.floor(Math.random() * 1e6);
        const qs = new URLSearchParams(params);
        qs.set("callback", cbName);
        const full = baseUrl + (baseUrl.includes("?") ? "&" : "?") + qs.toString();

        let done = false;
        const cleanup = () => {
          done = true;
          try { delete window[cbName]; } catch(e){}
          try { script.remove(); } catch(e){}
          clearTimeout(t);
        };

        window[cbName] = (data) => { if (done) return; cleanup(); resolve(data); };

        const t = setTimeout(() => { if (done) return; cleanup(); reject(new Error("JSONP timeout")); }, timeoutMs);

        const script = document.createElement("script");
        script.src = full;
        script.onerror = () => { if (done) return; cleanup(); reject(new Error("JSONP network error")); };
        document.head.appendChild(script);
      });
    }

    // ========= UI HELPERS =========
    function todayIso(d = new Date()) { return d.toISOString().slice(0,10); }
    function daysAgoIso(n) { const d = new Date(); d.setDate(d.getDate() - n); return d.toISOString().slice(0,10); }
// ================== TRANSCRIPTS (client) ==================
let TR_SELECTED = null;

function trCollect() {
  return {
    from: document.getElementById('tr_from').value || '',
    to: document.getElementById('tr_to').value || '',
    keywords: document.getElementById('tr_kw').value || '',
    limit: 10
  };
}

async function findTranscripts() {
  const btn = document.getElementById('trFindBtn');
  const busy = document.getElementById('busy');
  const busyText = document.getElementById('busyText');

  btn.disabled = true;
  document.getElementById('tr_results').textContent = '';
  document.getElementById('tr_qa').hidden = true;
  TR_SELECTED = null;

  if (busy) { busyText.textContent = 'Searching Drive…'; busy.hidden = false; }

  try {
    const p = trCollect();
    const data = await jsonp(GAS_BASE, { action: 'findTranscripts', ...p }, 90000);

    if (!data || data.ok === false) {
      document.getElementById('tr_results').innerHTML =
        "<span class='error'>" + (data && data.error ? escapeHtml(data.error) : "Search failed") + "</span>";
    } else {
      renderTranscriptResults(data.results || []);
    }
  } catch (err) {
    document.getElementById('tr_results').innerHTML = "<span class='error'>" + escapeHtml(err.message) + "</span>";
  } finally {
    btn.disabled = false;
    if (busy) busy.hidden = true;
  }
}

function renderTranscriptResults(items) {
  const el = document.getElementById('tr_results');
  if (!items.length) { el.innerHTML = "<span class='muted'>No transcripts found.</span>"; return; }

  el.innerHTML = items.map((f) => {
    const date = (f.modified || '').slice(0, 10);
    const prev = (f.preview || '').replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
    return `
      <div class="card" style="margin:10px 0; padding:12px;">
        <label style="display:flex; gap:10px; align-items:center;">
          <input type="radio" name="tr_pick"
                 value="${f.id}"
                 onchange="selectTranscript('${f.id}', '${encodeURIComponent(f.name||"")}', '${encodeURIComponent(f.mimeType||"")}', '${encodeURIComponent(prev)}', '${encodeURIComponent(f.link||"")}')">
          <strong>${escapeHtml(f.name || "(untitled)")}</strong>
          <span class="tag">${date}</span>
          ${f.link ? `<a href="${f.link}" target="_blank" style="margin-left:auto">Open</a>` : ""}
        </label>
        <div class="muted" style="margin-top:6px">${prev ? prev.slice(0, 300) + '…' : '(no preview)'}</div>
      </div>`;
  }).join('');
}

function selectTranscript(id, encName, encMime, encPrev, encLink) {
  TR_SELECTED = {
    id,
    name: decodeURIComponent(encName || ''),
    mimeType: decodeURIComponent(encMime || ''),
    preview: decodeURIComponent(encPrev || ''),
    link: decodeURIComponent(encLink || '')
  };
  document.getElementById('tr_meta').innerHTML =
    `<strong>${escapeHtml(TR_SELECTED.name)}</strong> ${TR_SELECTED.link ? `• <a href="${TR_SELECTED.link}" target="_blank">Open</a>` : ''}`;
  document.getElementById('tr_preview').textContent = TR_SELECTED.preview || '(preview unavailable)';
  document.getElementById('tr_qa').hidden = false;
}

async function askTranscript() {
  if (!TR_SELECTED) { alert('Please choose a transcript.'); return; }
  const q = (document.getElementById('tr_q').value || '').trim();
  if (!q) { document.getElementById('tr_err').textContent = 'Please enter a question.'; return; }

  const btn = document.getElementById('trAskBtn');
  const busy = document.getElementById('busy');
  const busyText = document.getElementById('busyText');

  btn.disabled = true;
  document.getElementById('tr_err').textContent = '';
  document.getElementById('tr_ans').innerHTML = '';

  if (busy) { busyText.textContent = 'Reading transcript…'; busy.hidden = false; }

  try {
    const data = await jsonp(GAS_BASE, {
      action: 'askTranscript',
      id: TR_SELECTED.id,
      mimeType: TR_SELECTED.mimeType,
      question: q
    }, 120000);

    if (!data || data.ok === false) {
      document.getElementById('tr_err').textContent = (data && data.error) ? data.error : 'Failed.';
    } else {
      document.getElementById('tr_ans').innerHTML = data.answer || '';
    }
  } catch (err) {
    document.getElementById('tr_err').textContent = err.message;
  } finally {
    btn.disabled = false;
    if (busy) busy.hidden = true;
  }
}

    function qrange(n) {
      document.getElementById("from").value = daysAgoIso(n);
      document.getElementById("to").value = todayIso();
    }
    function clearDates() {
      document.getElementById("from").value = "";
      document.getElementById("to").value = "";
    }
    function resetForm() {
      document.getElementById("question").value = "";
      document.getElementById("topic").value = "";
      document.getElementById("countries").value = "";
      document.getElementById("type").value = "all";
      document.getElementById("speed").value = "100";
      document.getElementById("style").value = "normal";
      clearDates();
      setAnswer("", "");
      setSources([]);
      setDebug("");
      document.getElementById("note").value = "";
      document.getElementById("meeting_id").value = "";
      document.getElementById("author").value = "";
      document.getElementById("noteMsg").textContent = "";
    }

    function setAnswer(html, err) {
      document.getElementById("answer").innerHTML = html || "";
      document.getElementById("err").textContent = err || "";
    }
    function setSources(srcs) {
      const el = document.getElementById("sources");
      if (!srcs || !srcs.length) { el.innerHTML = "<span class='muted'>—</span>"; return; }
      el.innerHTML = srcs.map(s => {
        const bits = [s.date, s.type, s.countries].filter(Boolean).join(" · ");
        return `<div><span class="tag">${bits||"source"}</span> ${escapeHtml(s.title||"")}</div>`;
      }).join("");
    }
    function setDebug(s) { document.getElementById("debug").textContent = s || ""; }
    function escapeHtml(x) { return (x||"").replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

    function collectFilters() {
      return {
        from: document.getElementById("from").value || "",
        to: document.getElementById("to").value || "",
        type: document.getElementById("type").value || "all",
        countries: document.getElementById("countries").value || "",
        topic: document.getElementById("topic").value || "",
        limit: document.getElementById("speed").value || "100",
        style: document.getElementById("style").value || "normal",
        question: document.getElementById("question").value || ""
      };
    }

    // ========= ACTIONS =========
  async function ask() {
    const btn = document.getElementById("askBtn");
    const busy = document.getElementById("busy");          // ← NEW
    // const busyText = document.getElementById("busyText"); // (optional if you want to change the label)
    btn.disabled = true; setAnswer("", ""); setDebug(""); setSources([]);

    const p = collectFilters();
    if (!p.question.trim()) { setAnswer("", "Please enter a question."); btn.disabled = false; return; }

    busy.hidden = false;                                    // ← NEW (show spinner)
    try {
      // bump timeout a bit so you don't hit 60s JSONP timeout during slow queries
      const data = await jsonp(GAS_BASE, { action: "ask", ...p }, 90000);
      if (!data || data.ok === false) {
        setAnswer("", "Error: " + (data && data.error ? data.error : "Unknown"));
      } else {
        setAnswer(data.answer || "", "");
        setSources(data.sources || []);
        const dbg = [
          "Request URL:\n" + GAS_BASE,
          "",
          "Supabase REST URL:\n" + (data.debug && data.debug.rest ? data.debug.rest : ""),
          "",
          "SQL (approximate):\n" + (data.debug && data.debug.sql_approx ? data.debug.sql_approx : ""),
          "",
          "Prompt (exact, sent to Gemini):\n" + (data.debug && data.debug.prompt ? data.debug.prompt : "")
        ].join("\n");
        setDebug(dbg);
      }
    } catch (err) {
      setAnswer("", "Error: " + err.message);
    } finally {
      busy.hidden = true;                                   // ← NEW (hide spinner)
      btn.disabled = false;
    }
  }


    async function saveNote() {
      const btn = document.getElementById("saveNoteBtn");
      btn.disabled = true;
      const noteMsg = document.getElementById("noteMsg");
      noteMsg.textContent = "";

      const p = collectFilters();
      const note = document.getElementById("note").value || "";
      const meeting_id = document.getElementById("meeting_id").value || "";
      const author = document.getElementById("author").value || "";
      const headline = (document.getElementById("note_headline")?.value || "").trim();


      if (!note.trim()) { noteMsg.textContent = "Please type a note."; btn.disabled = false; return; }

      try {
        const data = await jsonp(GAS_BASE, {
          action: "addNote",
          note,
          meeting_id,
          author,
          headline,
          // pass filters/meta too:
          from: p.from, to: p.to, type: p.type, countries: p.countries,
          topic: p.topic, style: p.style, question: p.question
        });

        if (!data || data.ok === false) {
          noteMsg.textContent = "Error saving note: " + (data && data.error ? data.error : "Unknown");
        } else {
          const tbl = data.result && data.result.table || "?";
          noteMsg.textContent = "Saved to table “" + tbl + "”.";
        }
      } catch (err) {
        noteMsg.textContent = "Error: " + err.message;
      } finally {
        btn.disabled = false;
      }
    }

    // ========= INIT =========
    // start with last 30 days (like your earlier default)
    qrange(30);
  </script>
</body>
</html>
