<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Teach For All — Knowledge Q&A</title>
<style>
  :root{
    --bg:#0f1220; --panel:#151a2e; --muted:#9aa3b2; --text:#e8ecf4; --brand:#6c63ff; --brand-2:#8f87ff; --error:#ff6b7a; --ok:#44d19a;
    --border: #252b43; --chip:#1d2340;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial}
  a{color:var(--brand)}
  .container{max-width:1100px;margin:0 auto;padding:26px}
  .title{font-size:28px;font-weight:800;display:flex;align-items:center;gap:10px}
  .badge{font-size:12px;padding:3px 8px;border-radius:16px;background:var(--chip);color:var(--muted)}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;margin-top:18px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input, select, textarea{width:100%;background:#0e1330;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px}
  textarea{min-height:120px;resize:vertical}
  .btn{border:0;border-radius:10px;padding:10px 18px;background:var(--brand);color:white;cursor:pointer;font-weight:600}
  .btn.secondary{background:#25305b}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .muted{color:var(--muted)}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{background:var(--chip);border:1px solid var(--border);border-radius:20px;padding:8px 10px;font-size:12px;cursor:pointer}
  .chip:hover{background:#222a52}
  .answer{white-space:pre-wrap;line-height:1.6}
  .divider{height:1px;background:var(--border);margin:10px 0}
  .small{font-size:12px}
  details{background:var(--chip);border:1px solid var(--border);border-radius:10px}
  summary{cursor:pointer;padding:10px 12px}
  .pad{padding:10px 12px;border-top:1px solid var(--border)}
  .ok{color:var(--ok)} .err{color:var(--error)}
  .footerNote{font-size:12px;color:var(--muted);text-align:right}
</style>
</head>
<body>
<div class="container">
  <div class="title">
    Teach For All — Knowledge Q&A
    <span class="badge" id="build">client-ui</span>
  </div>

  <div class="panel">
    <div class="row">
      <div>
        <label>From date</label>
        <input type="date" id="from">
      </div>
      <div>
        <label>To date</label>
        <input type="date" id="to">
      </div>
    </div>

    <div style="margin-top:10px">
      <label>Quick ranges</label>
      <div class="chips">
        <button class="chip" onclick="quickRange(7)">Past 7 days</button>
        <button class="chip" onclick="quickRange(30)">Past month</button>
        <button class="chip" onclick="quickRange(90)">Last 3 months</button>
        <button class="chip" onclick="clearDates()">Clear dates</button>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <div>
        <label>Type</label>
        <select id="type">
          <option value="all">All (default)</option>
          <option>Zoom Meeting</option>
          <option>Email</option>
          <option>Note</option>
        </select>
      </div>
      <div>
        <label>Countries (comma-separated)</label>
        <input id="countries" placeholder="e.g., Portugal, Spain" />
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <div>
        <label>Topic (optional)</label>
        <input id="topic" placeholder="standards, onboarding, budget…" />
      </div>
      <div>
        <label>Response speed</label>
        <select id="speed">
          <option value="50">Fast (~50 rows)</option>
          <option value="100" selected>Medium (~100 rows)</option>
          <option value="200">Slower (~200 rows)</option>
        </select>
        <div class="small muted">More rows = more context, potentially slower.</div>
      </div>
    </div>

    <div style="margin-top:12px">
      <label>Question</label>
      <textarea id="question" placeholder="Ask your question… e.g., What are Italy’s priorities from the last two weeks?"></textarea>
    </div>

    <div class="row" style="margin-top:12px;align-items:end">
      <div>
        <label>Answer style</label>
        <select id="style">
          <option value="normal" selected>normal</option>
          <option value="short">short</option>
        </select>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button class="btn" onclick="ask()">Ask</button>
        <button class="btn secondary" onclick="resetForm()">Reset</button>
      </div>
    </div>
  </div>

  <div class="panel" id="results">
    <div class="small muted" id="filters">—</div>
    <h3>Answer</h3>
    <div id="answer" class="answer muted">—</div>

    <div class="divider"></div>
    <h4>Sources</h4>
    <div id="sources" class="small muted">—</div>

    <details style="margin-top:12px">
      <summary>Debug — Request, REST, SQL, Prompt & Raw JSON</summary>
      <div class="pad small">
        <div><b>Request URL</b></div>
        <div id="reqUrl" class="muted" style="word-break:break-all"></div>
        <div class="divider"></div>
        <div><b>Supabase REST URL</b></div>
        <div id="restUrl" class="muted" style="word-break:break-all"></div>
        <div class="divider"></div>
        <div><b>SQL (approximate)</b></div>
        <pre id="sql" class="muted" style="white-space:pre-wrap"></pre>
        <div class="divider"></div>
        <div><b>Prompt (exact, sent to Gemini)</b></div>
        <pre id="prompt" style="white-space:pre-wrap"></pre>
        <div class="divider"></div>
        <div><b>Response JSON</b></div>
        <pre id="raw" style="white-space:pre-wrap"></pre>
      </div>
    </details>
  </div>

  <div class="panel">
    <h3>Add a note</h3>
    <div class="grid-4">
      <div>
        <label>Date</label>
        <input type="date" id="noteDate">
      </div>
      <div>
        <label>Type</label>
        <select id="noteType">
          <option value="Note" selected>Note</option>
          <option>Email</option>
          <option>Zoom Meeting</option>
        </select>
      </div>
      <div style="grid-column: span 2">
        <label>Recipients (optional)</label>
        <input id="noteRecipients" placeholder="e.g., Ramona, Jeff">
      </div>
    </div>
    <div style="margin-top:12px">
      <label>Summary (note)</label>
      <textarea id="noteSummary" placeholder="Write your note…"></textarea>
    </div>
    <div style="margin-top:10px;text-align:right">
      <button class="btn" onclick="saveNote()">Save note</button>
    </div>
  </div>

  <div class="footerNote" id="foot"></div>
</div>

<script>
  // ************ CONFIG ************
  const ENDPOINT = "https://script.google.com/macros/s/AKfycbyvzIgN1uiRtnQh9SkjHo8ADtm66NrX2b1uIWr_vQ6XweQZvu1r9izXIVtPWzF7SuDZ/exec";

  const $ = id => document.getElementById(id);
  const todayISO = () => new Date().toISOString().slice(0,10);

  function quickRange(days){
    const to = new Date();
    const from = new Date();
    from.setDate(to.getDate() - days);
    $('from').value = from.toISOString().slice(0,10);
    $('to').value   = to.toISOString().slice(0,10);
  }
  function clearDates(){ $('from').value=''; $('to').value=''; }

  function resetForm(){
    $('from').value = '';
    $('to').value = '';
    $('type').value = 'all';
    $('countries').value = '';
    $('topic').value = '';
    $('speed').value = '100';
    $('question').value = '';
    $('style').value = 'normal';
    $('answer').textContent = '—';
    $('sources').textContent = '—';
    $('filters').textContent = '—';
    $('reqUrl').textContent = '';
    $('restUrl').textContent = '';
    $('sql').textContent = '';
    $('prompt').textContent = '';
    $('raw').textContent = '';
  }

  (function init(){
    $('build').textContent = 'client-ui';
    $('noteDate').value = todayISO();
    $('foot').textContent = 'Ready';
  })();

  async function ask(){
    const p = new URLSearchParams({
      action: 'ask',
      from: $('from').value,
      to: $('to').value,
      type: $('type').value,
      countries: $('countries').value,
      topic: $('topic').value,
      limit: $('speed').value,
      style: $('style').value,
      question: $('question').value,
      ts: Date.now().toString()
    });

    const url = `${ENDPOINT}?${p.toString()}`;

    $('reqUrl').textContent = url;
    $('answer').textContent = 'Working…';
    $('sources').textContent = '—';
    $('filters').textContent = '—';
    $('foot').textContent = 'Querying…';

    try{
      const res = await fetch(url, { method:'GET', cache:'no-store', redirect:'follow' });
      const json = await res.json().catch(async ()=>({ ok:false, error:`HTTP ${res.status}`, body: await res.text().catch(()=> '') }));

      $('raw').textContent = JSON.stringify(json, null, 2);

      if (!json.ok){
        $('answer').innerHTML = `<span class="err">Error:</span> ${json.error || 'Unknown'}`
        $('foot').textContent = 'Error';
        if (json.rest) $('restUrl').textContent = json.rest;
        if (json.debug?.sql_approx) $('sql').textContent = json.debug.sql_approx;
        if (json.prompt) $('prompt').textContent = json.prompt;
        return;
      }

      $('filters').textContent = json.filters || '';
      $('answer').textContent = json.answer || '(no answer)';
      $('sources').innerHTML = (json.sources||[])
        .map(s => `• <b>${escapeHtml(s.title || '(untitled)')}</b> (${escapeHtml(s.date||'—')} · ${escapeHtml(s.type||'—')} · ${escapeHtml(s.countries||'None')})`)
        .join('<br>') || '—';
      $('restUrl').textContent = json.debug?.rest || '';
      $('sql').textContent = json.debug?.sql_approx || '';
      $('prompt').textContent = json.debug?.prompt || '';
      $('foot').textContent = 'Done';
    } catch(err){
      $('answer').innerHTML = `<span class="err">Error:</span> ${err.message}`;
      $('foot').textContent = 'Error';
      console.error(err);
    }
  }

  async function saveNote(){
    const form = new URLSearchParams({
      action: 'add_note',
      date: $('noteDate').value,
      type: $('noteType').value,   // Now "Note", "Email", "Zoom Meeting"
      recipients: $('noteRecipients').value,
      summary: $('noteSummary').value
    });

    try{
      const res = await fetch(ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type':'application/x-www-form-urlencoded' },
        body: form.toString(),
        cache: 'no-store',
        redirect: 'follow'
      });

      const json = await res.json().catch(async ()=>({ ok:false, error:`HTTP ${res.status}`, body: await res.text().catch(()=> '') }));

      if (!json.ok){
        alert(`Error saving note:\n${json.error || 'Unknown'}\n${json.body ? `\n${json.body.substring(0,400)}` : ''}`);
        return;
      }

      alert(`Saved! id: ${json.id || '(n/a)'}`);
      $('noteSummary').value = '';
      $('noteRecipients').value = '';
    } catch(err){
      alert(`Error saving note: ${err.message}`);
    }
  }

  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) }
</script>
</body>
</html>
