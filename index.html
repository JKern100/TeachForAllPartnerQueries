<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Teach For All — Knowledge Q&A</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{
    --bg:#0b1220; --card:#111a2b; --ink:#e8edf7; --muted:#a6b0c3;
    --accent:#4f8cff; --accent-2:#2a6ef0; --ok:#2ecc71; --warn:#f39c12;
    --radius:16px;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;}
  .wrap{max-width:1000px;margin:0 auto;padding:28px 16px 64px;}
  h1{display:flex;align-items:center;gap:12px;font-size:28px;margin:0 0 16px;}
  .badge{background:#23385f;padding:4px 10px;border-radius:999px;font-size:12px;color:#cdd6e8}
  .card{background:var(--card);border:1px solid #203255;border-radius:var(--radius);padding:18px 16px;margin:16px 0;}
  label{display:block;margin:10px 0 6px;color:var(--muted);font-size:13px}
  input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #31486f;background:#0e1626;color:var(--ink);}
  textarea{min-height:100px;resize:vertical}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .btn{background:var(--accent);border:none;color:white;padding:12px 18px;border-radius:12px;font-weight:600;cursor:pointer}
  .btn:hover{background:var(--accent-2)}
  .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .muted{color:var(--muted);font-size:13px}
  .answer{white-space:pre-wrap}
  details{background:#0d1626;border:1px dashed #2a3f63;border-radius:12px;padding:8px 10px}
  details>summary{cursor:pointer;font-weight:600;margin:4px 0 8px}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#1b2a46;color:#9eb1d5;font-size:12px}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Teach For All — Knowledge Q&amp;A <span id="build" class="badge"></span></h1>
    <p class="muted">Filter by date, countries, and type; ask your question; get an AI-generated answer with sources.</p>

    <!-- Query form -->
    <section class="card">
      <div class="toolbar" style="justify-content:space-between">
        <div class="toolbar" style="gap:12px">
          <label style="display:flex;align-items:center;gap:8px"><input id="chatMode" type="checkbox"> Chat mode (remember this thread)</label>
          <span class="pill">Thread: <span id="threadId">(new)</span></span>
          <button class="btn" type="button" onclick="newChat()">New chat</button>
        </div>
      </div>

      <div class="grid">
        <div style="grid-column:span 3">
          <label>From date</label>
          <input type="date" id="from">
        </div>
        <div style="grid-column:span 3">
          <label>To date</label>
          <input type="date" id="to">
        </div>
        <div style="grid-column:span 6">
          <label>Countries (comma-separated)</label>
          <input id="countries" placeholder="Portugal, Spain (leave blank = all)">
        </div>

        <div style="grid-column:span 3">
          <label>Type</label>
          <select id="type">
            <option>All (default)</option>
            <option>Zoom Meeting</option>
            <option>Email</option>
            <option>Note</option>
          </select>
        </div>
        <div style="grid-column:span 3">
          <label>Topic (optional)</label>
          <input id="topic" placeholder="standards">
        </div>
        <div style="grid-column:span 12">
          <label>Question</label>
          <textarea id="question" placeholder="e.g., What are Italy’s priorities?"></textarea>
        </div>

        <div style="grid-column:span 3">
          <label>Answer style</label>
          <select id="style">
            <option value="normal" selected>normal</option>
            <option value="short">short</option>
          </select>
        </div>
        <div style="grid-column:span 4">
          <label>Response speed</label>
          <select id="speed">
            <option value="50" selected>Fast (≈ 50 rows)</option>
            <option value="100">Medium (≈ 100 rows)</option>
            <option value="200">Slower (≈ 200 rows)</option>
          </select>
          <div class="muted">Higher = more context, a bit slower.</div>
        </div>
        <div style="grid-column:span 5;display:flex;align-items:flex-end;justify-content:flex-end">
          <button class="btn" onclick="ask()">Ask</button>
        </div>
      </div>

      <p class="muted" id="filtersLine"></p>

      <div class="answer" id="answer"></div>

      <h3>Sources</h3>
      <ul id="sources"></ul>

      <details id="dbg">
        <summary>Debug — Request, REST, SQL, Prompt &amp; Raw JSON</summary>
        <div>
          <label>Request URL</label>
          <input id="reqUrl" readonly>
        </div>
        <div>
          <label>Supabase REST URL</label>
          <input id="restUrl" readonly>
        </div>
        <div>
          <label>SQL (approximate)</label>
          <textarea id="sqlApprox" readonly></textarea>
        </div>
        <div>
          <label>Prompt (exact, sent to Gemini)</label>
          <textarea id="promptOut" readonly></textarea>
        </div>
        <div>
          <label>Response JSON</label>
          <textarea id="jsonOut" readonly style="min-height:180px"></textarea>
        </div>
      </details>
    </section>

    <!-- Add note -->
    <section class="card">
      <h2 style="margin-top:0">Add note</h2>
      <div class="grid">
        <div style="grid-column:span 3">
          <label for="n_date">Date</label>
          <input id="n_date" type="date">
        </div>
        <div style="grid-column:span 3">
          <label for="n_type">Type</label>
          <select id="n_type">
            <option>Note</option>
            <option>Zoom Meeting</option>
            <option>Email</option>
          </select>
        </div>
        <div style="grid-column:span 6">
          <label for="n_recipients">Recipients (optional)</label>
          <input id="n_recipients" placeholder="Ramona; João; …">
        </div>
        <div style="grid-column:span 6">
          <label for="n_countries">Countries (optional)</label>
          <input id="n_countries" placeholder="Latvia, Portugal">
        </div>
        <div style="grid-column:span 12">
          <label for="n_summary">Summary (note body)</label>
          <textarea id="n_summary" placeholder="Write your note…"></textarea>
        </div>
        <div style="grid-column:span 12;display:flex;justify-content:flex-end">
          <button class="btn" onclick="e()">Save note</button>
        </div>
      </div>
      <p class="muted">You must be signed into your <strong>@teachforallnetwork.org</strong> account in this browser. Inserts are authenticated by the Apps Script web app.</p>
    </section>
  </div>

<script>
  // ====== CONFIG ======
  const ENDPOINT = "https://script.google.com/macros/s/AKfycbyvzIgN1uiRtnQh9SkjHo8ADtm66NrX2b1uIWr_vQ6XweQZvu1r9izXIVtPWzF7SuDZ/exec";

  // ====== State ======
  const S = {
    thread: localStorage.getItem("tfa_thread") || "",
    lastBuild: ""
  };

  // ====== Init ======
  (function init(){
    document.getElementById("build").textContent = "…";
    document.getElementById("threadId").textContent = S.thread || "(new)";
    // default "Add note" date = today
    const d = new Date().toISOString().slice(0,10);
    document.getElementById("n_date").value = d;
  })();

  function newChat(){
    S.thread = String(Date.now());
    localStorage.setItem("tfa_thread", S.thread);
    document.getElementById("threadId").textContent = S.thread;
  }

  function filtersLineText(filters){
    const parts = [];
    if (filters.from) parts.push(`from: ${filters.from}`);
    if (filters.to) parts.push(`to: ${filters.to}`);
    if (filters.countries) parts.push(`countries: ${filters.countries}`);
    if (filters.type && filters.type !== "All (default)") parts.push(`type: ${filters.type}`);
    parts.push(`limit: ${filters.limit}`);
    parts.push(`style: ${filters.style}`);
    return "Filters — " + parts.join(" | ");
  }

  async function ask(){
    const params = new URLSearchParams();
    const from = document.getElementById("from").value;
    const to   = document.getElementById("to").value;
    const ctry = document.getElementById("countries").value.trim();
    const type = document.getElementById("type").value;
    const topic= document.getElementById("topic").value.trim();
    const question = document.getElementById("question").value.trim();
    const style = document.getElementById("style").value;
    const limit = document.getElementById("speed").value;
    const chatMode = document.getElementById("chatMode").checked;

    if (from) params.set("from", from);
    if (to) params.set("to", to);
    if (ctry) params.set("countries", ctry);
    if (type) params.set("type", type);
    if (topic) params.set("topic", topic);
    if (question) params.set("question", question);
    if (style) params.set("style", style);
    if (limit) params.set("limit", limit);
    if (chatMode && S.thread) params.set("thread", S.thread);

    const url = ENDPOINT + "?" + params.toString();
    const r = await fetch(url, { credentials: "include" });
    const data = await r.json().catch(()=>({error:"Invalid JSON"}));

    document.getElementById("build").textContent = data.build || "";
    document.getElementById("filtersLine").textContent =
      filtersLineText({ from, to, countries: ctry, type, limit, style });

    document.getElementById("answer").textContent = data.answer || "(no answer)";
    const ul = document.getElementById("sources"); ul.innerHTML = "";
    (data.sources || []).forEach(s => {
      const li = document.createElement("li");
      li.textContent = `${s.title} (${s.date || "n/a"} · ${s.type || "n/a"} · ${s.countries || "—"})`;
      ul.appendChild(li);
    });

    // Debug
    document.getElementById("reqUrl").value = data?.debug?.request_url || url;
    document.getElementById("restUrl").value = data?.debug?.supabase_rest_url || "";
    document.getElementById("sqlApprox").value = data?.debug?.sql_approx || "";
    document.getElementById("promptOut").value = data?.debug?.prompt_used || "";
    document.getElementById("jsonOut").value = JSON.stringify(data, null, 2);
  }

  async function saveNote(){
    <script>
async function saveNote(){
  const date       = document.getElementById("n_date").value || new Date().toISOString().slice(0,10);
  const type       = document.getElementById("n_type").value || "Note";
  const recipients = document.getElementById("n_recipients").value || "";
  const countries  = document.getElementById("n_countries").value || "";
  const summary    = document.getElementById("n_summary").value.trim();
  const statusEl   = document.getElementById("n_status");

  if (!summary){
    statusEl.innerHTML = `<span class="err">Please enter a note summary.</span>`;
    return;
  }
  statusEl.textContent = "Saving…";

  try {
    // IMPORTANT: no headers; let the browser send application/x-www-form-urlencoded
    const body = new URLSearchParams({
      action: "insert",
      date, type, recipients, countries, summary
    });

    const res  = await fetch(ENDPOINT, { method: "POST", body });
    const data = await res.json();

    if (data.ok) {
      statusEl.innerHTML = `<span class="ok">Saved.</span>`;
      document.getElementById("n_summary").value = "";
    } else {
      statusEl.innerHTML = `<span class="err">Failed: ${data.error || "Unknown error"}</span>`;
      alert(`Error saving note: ${data.error || "Unknown error"}`);
    }
  } catch (err) {
    statusEl.innerHTML = `<span class="err">Error: ${err.message}</span>`;
    alert(`Error saving note: ${err.message}`);
    console.error(err);
  }
}
</script>
</body>
</html>
