<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Teach For All — Knowledge Q&A</title>
<style>
  :root{
    --bg:#0f1220; --panel:#151a2e; --muted:#9aa3b2; --text:#e8ecf4; --brand:#6c63ff;
    --border:#252b43; --chip:#1d2340; --ok:#44d19a; --err:#ff6b7a;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
  .container{max-width:1100px;margin:0 auto;padding:26px}
  h1{font-size:28px;margin:0 0 12px;font-weight:800}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;margin-top:18px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input, select, textarea{width:100%;background:#0e1330;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px}
  textarea{min-height:120px;resize:vertical}
  .chip{background:var(--chip);border:1px solid var(--border);border-radius:18px;padding:6px 10px;font-size:12px;cursor:pointer;margin-right:6px}
  .btn{border:0;border-radius:10px;padding:10px 18px;background:var(--brand);color:#fff;cursor:pointer;font-weight:600}
  .btn.secondary{background:#25305b}
  .muted{color:var(--muted)}
  .answer{line-height:1.6}
  .divider{height:1px;background:var(--border);margin:10px 0}
  .err{color:var(--err)}
</style>
</head>
<body>
<div class="container">
  <h1>Teach For All — Knowledge Q&A <span class="muted" id="build">client-ui</span></h1>

  <div class="panel">
    <div class="row">
      <div>
        <label>From date</label>
        <input type="date" id="from">
      </div>
      <div>
        <label>To date</label>
        <input type="date" id="to">
      </div>
    </div>

    <div style="margin-top:10px">
      <label>Quick ranges</label>
      <button class="chip" onclick="quickRange(7)">Past 7 days</button>
      <button class="chip" onclick="quickRange(30)">Past month</button>
      <button class="chip" onclick="quickRange(90)">Last 3 months</button>
      <button class="chip" onclick="clearDates()">Clear dates</button>
    </div>

    <div class="row" style="margin-top:12px">
      <div>
        <label>Type</label>
        <select id="type">
          <option value="all">All (default)</option>
          <option>Zoom Meeting</option>
          <option>Email</option>
          <option>Note</option>
        </select>
      </div>
      <div>
        <label>Countries (comma-separated)</label>
        <input id="countries" placeholder="e.g., Portugal, Spain" />
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <div>
        <label>Topic (optional)</label>
        <input id="topic" placeholder="standards, onboarding, budget…" />
      </div>
      <div>
        <label>Response speed</label>
        <select id="speed">
          <option value="50">Fast (~50 rows)</option>
          <option value="100" selected>Medium (~100 rows)</option>
          <option value="200">Slower (~200 rows)</option>
        </select>
        <div class="muted" style="font-size:12px">More rows = more context.</div>
      </div>
    </div>

    <div style="margin-top:12px">
      <label>Question</label>
      <textarea id="question" placeholder="Ask your question… e.g., What was my last meeting with Pedro about?"></textarea>
    </div>

    <div class="row" style="margin-top:12px;align-items:end">
      <div>
        <label>Answer style</label>
        <select id="style">
          <option value="normal" selected>normal</option>
          <option value="short">short</option>
        </select>
      </div>
      <div style="text-align:right">
        <button class="btn" onclick="ask()">Ask</button>
        <button class="btn secondary" onclick="resetForm()">Reset</button>
      </div>
    </div>
  </div>

  <div class="panel" id="results">
    <div class="muted" id="filters">—</div>
    <h3>Answer</h3>
    <div id="answer" class="answer muted">—</div>

    <div class="divider"></div>
    <details>
      <summary>Debug — Request, REST, SQL, Prompt & Raw JSON</summary>
      <div style="padding:8px 0">
        <div><b>Request URL</b></div>
        <div id="reqUrl" class="muted" style="word-break:break-all"></div>
        <div class="divider"></div>
        <div><b>Supabase REST URL</b></div>
        <div id="restUrl" class="muted" style="word-break:break-all"></div>
        <div class="divider"></div>
        <div><b>SQL (approximate)</b></div>
        <pre id="sql" class="muted" style="white-space:pre-wrap"></pre>
        <div class="divider"></div>
        <div><b>Prompt (exact, sent to Gemini)</b></div>
        <pre id="prompt" style="white-space:pre-wrap"></pre>
        <div class="divider"></div>
        <div><b>Response JSON</b></div>
        <pre id="raw" style="white-space:pre-wrap"></pre>
      </div>
    </details>
  </div>
</div>

<script>
  // === SET YOUR WEB APP URL HERE (the /exec URL from Apps Script deploy) ===
  const ENDPOINT = "YOUR_APPS_SCRIPT_EXEC_URL";

  const $ = id => document.getElementById(id);
  const todayISO = () => new Date().toISOString().slice(0,10);

  function quickRange(days){
    const to = new Date();
    const from = new Date();
    from.setDate(to.getDate()-days);
    $('from').value = from.toISOString().slice(0,10);
    $('to').value   = to.toISOString().slice(0,10);
  }
  function clearDates(){ $('from').value=''; $('to').value=''; }

  function resetForm(){
    $('from').value = '';
    $('to').value = '';
    $('type').value = 'all';
    $('countries').value = '';
    $('topic').value = '';
    $('speed').value = '100';
    $('question').value = '';
    $('style').value = 'normal';
    $('answer').textContent = '—';
    $('filters').textContent = '—';
    $('reqUrl').textContent = '';
    $('restUrl').textContent = '';
    $('sql').textContent = '';
    $('prompt').textContent = '';
    $('raw').textContent = '';
  }

  (function init(){
    $('build').textContent = 'client-ui';
  })();

  // JSONP tiny helper
  function jsonp(url, timeoutMs=15000){
    return new Promise((resolve, reject)=>{
      const cbName = "__jsonp_cb_" + Math.floor(Math.random()*1e6);
      const full = url + (url.includes("?")?"&":"?") + "callback=" + cbName;

      let done = false;
      const to = setTimeout(()=>{
        if (done) return;
        done = true;
        cleanup();
        reject(new Error("JSONP timeout"));
      }, timeoutMs);

      function cleanup(){
        try { delete window[cbName]; } catch(_){}
        try {
          if (script && script.parentNode) script.parentNode.removeChild(script);
        } catch(_){}
        clearTimeout(to);
      }

      window[cbName] = data => {
        if (done) return;
        done = true;
        cleanup();
        resolve(data);
      };

      const script = document.createElement('script');
      script.src = full;
      script.onerror = () => {
        if (done) return;
        done = true;
        cleanup();
        reject(new Error("JSONP network error"));
      };
      document.head.appendChild(script);
    });
  }

  async function ask(){
    const p = new URLSearchParams({
      action: 'ask',
      from: $('from').value,
      to: $('to').value,
      type: $('type').value,
      countries: $('countries').value,
      topic: $('topic').value,
      limit: $('speed').value,
      style: $('style').value,
      question: $('question').value,
      ts: Date.now().toString()
    });

    const url = `${ENDPOINT}?${p.toString()}`;
    $('reqUrl').textContent = url;
    $('filters').textContent = '—';
    $('answer').innerHTML = '<i>Working…</i>';
    $('restUrl').textContent = '';
    $('sql').textContent = '';
    $('prompt').textContent = '';
    $('raw').textContent = '';

    try{
      const json = await jsonp(url, 20000);
      $('raw').textContent = JSON.stringify(json, null, 2);

      if (!json.ok){
        $('answer').innerHTML = `<span class="err">Error:</span> ${json.error || 'Unknown'}`;
        return;
      }

      $('filters').textContent = json.filters || '';
      // IMPORTANT: render as HTML (not as text)
      $('answer').innerHTML = json.answer || '(no answer)';
      $('restUrl').textContent = json.debug?.rest || '';
      $('sql').textContent = json.debug?.sql_approx || '';
      $('prompt').textContent = json.debug?.prompt || '';

    } catch(err){
      $('answer').innerHTML = `<span class="err">Error:</span> ${err.message}`;
      console.error(err);
    }
  }
</script>
</body>
</html>
