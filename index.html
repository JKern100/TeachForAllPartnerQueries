<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Teach For All — Knowledge Q&A</title>
  <meta name="description" content="Ask questions against Teach For All meeting data and get AI-powered answers with sources." />
  <style>
    :root { color-scheme: light dark; --bg:#0b0d10; --fg:#e8eaed; --card:#0f1216; --muted:#a8b0b9; --line:#2a2e33; --brand:#5b8cff; --brand-2:#7cc4ff; }
    @media (prefers-color-scheme:light){
      :root{ --bg:#f6f8fb; --fg:#0b0d10; --card:#ffffff; --muted:#5a6675; --line:#e5e8ec; --brand:#0b66ff; --brand-2:#63a2ff;}
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .hero{background:linear-gradient(125deg, var(--brand) 0%, var(--brand-2) 100%); color:#fff; padding:48px 24px;}
    .hero .wrap{max-width:1100px;margin:0 auto}
    .title{font-weight:800;letter-spacing:.2px;margin:0 0 8px}
    .subtitle{opacity:.92;margin:0}
    .build{display:inline-block;margin-left:.5rem;padding:.2rem .6rem;border:1px solid rgba(255,255,255,.35);border-radius:999px;font-size:.8rem;opacity:.95}

    .wrap{max-width:1100px;margin:0 auto;padding:28px 16px}
    .card{background:var(--card); border:1px solid var(--line); border-radius:16px; padding:22px; box-shadow:0 8px 30px rgba(0,0,0,.08)}
    .grid{display:grid; gap:14px}
    .g2{grid-template-columns:1fr 1fr}
    .g3{grid-template-columns:repeat(3,1fr)}
    @media (max-width:900px){ .g2,.g3{grid-template-columns:1fr} }

    label{font-weight:600; font-size:.95rem}
    input,select,textarea,button{width:100%;padding:.7rem .8rem;border-radius:12px;border:1px solid var(--line);background:transparent;color:var(--fg)}
    textarea{min-height:90px; resize:vertical}
    .hint{font-size:.85rem; color:var(--muted); margin-top:6px}
    .btn{cursor:pointer; background:var(--brand); color:#fff; border-color:transparent; font-weight:700}
    .btn:disabled{opacity:.7; cursor:default}

    .out{margin-top:18px}
    .muted{color:var(--muted)}
    .requrl{font-size:.9rem; white-space:nowrap; overflow:auto; border:1px dashed var(--line); padding:.5rem .6rem; border-radius:10px; background:transparent}
    .sources ul{margin:.5rem 0 0;padding-left:1.25rem}
    .sources li{margin:.25rem 0}
    details{margin-top:.75rem}
    summary{cursor:pointer}
    pre{white-space:pre-wrap; overflow:auto; margin:0}

    /* Answer rendering: paragraphs + lists look nice */
    #answer p{margin:.4rem 0;}
    #answer ul{margin:.4rem 0 .4rem 1.25rem;}
    #answer li{margin:.2rem 0;}
    .chat{border:1px solid var(--line); border-radius:12px; padding:12px; background:transparent; max-height:320px; overflow:auto}
    .msg{margin:.4rem 0; padding:.5rem .6rem; border-radius:10px}
    .user{background:rgba(91,140,255,.12)}
    .assistant{background:rgba(124,196,255,.12)}
    .chatmeta{display:flex; gap:12px; align-items:center}
    .switch{display:flex; align-items:center; gap:10px}
    .row{display:flex; gap:10px; align-items:center}
  </style>
</head>
<body>

  <section class="hero">
    <div class="wrap">
      <h1 class="title">Teach For All — Knowledge Q&A <span id="buildTag" class="build"></span></h1>
      <p class="subtitle">Filter by date, countries, type; add a topic; ask your question; get an AI-generated answer with sources.</p>
    </div>
  </section>

  <main class="wrap">
    <div class="card">
      <!-- Chat controls -->
      <div class="grid g2">
        <div class="switch">
          <label for="chat">Chat mode (remember this thread)</label>
          <input id="chat" type="checkbox" />
        </div>
        <div class="row">
          <div class="muted" id="threadDisplay">Thread: —</div>
          <button id="newChat" type="button" class="btn" style="max-width:180px">New chat</button>
        </div>
      </div>
      <div class="chat" id="chatBox" hidden></div>

      <form id="qf" class="grid" style="margin-top:16px">
        <div class="grid g3">
          <div>
            <label for="from">From date</label>
            <input id="from" name="from" type="date" />
          </div>
          <div>
            <label for="to">To date</label>
            <input id="to" name="to" type="date" />
          </div>
          <div>
            <label for="countries">Countries (comma-separated)</label>
            <input id="countries" name="countries" placeholder="Portugal, Spain (leave blank = all)" />
          </div>
        </div>

        <div class="grid g2">
          <div>
            <label for="type">Type</label>
            <select id="type" name="type">
              <option value="">All (default)</option>
              <option value="Zoom Meeting">Zoom meeting</option>
              <option value="Email">Email</option>
              <option value="Note">Note</option>
            </select>
          </div>
          <div>
            <label for="topic">Topic (optional)</label>
            <input id="topic" name="topic" placeholder="standards" />
          </div>
        </div>

        <div>
          <label for="question">Question</label>
          <textarea id="question" name="question" placeholder="e.g., What are the next steps for network standards?"></textarea>
        </div>

        <div class="grid g3">
          <div>
            <label for="style">Answer style</label>
            <select id="style" name="style">
              <option value="normal">normal</option>
              <option value="short" selected>short</option>
            </select>
          </div>

          <div>
            <label for="speed">Response speed</label>
            <select id="speed" name="speed" title="Controls how many rows are sent as context">
              <option value="fast" selected>Fast (≈ 50 rows)</option>
              <option value="medium">Medium (≈ 100 rows)</option>
              <option value="slow">Slower (≈ 200 rows)</option>
            </select>
            <div class="hint">Fast = 50 · Medium = 100 · Slower = 200</div>
          </div>

          <div style="display:flex; align-items:flex-end">
            <button id="askBtn" class="btn" type="submit">Ask</button>
          </div>
        </div>

        <input id="limit" name="limit" type="hidden" value="50" />
      </form>

      <section class="out">
        <div class="muted" id="filters">Filters — none</div>
        <h3 style="margin:.35rem 0 .5rem">Answer</h3>
        <div id="answer">—</div>

        <div id="sources" class="sources"></div>

        <details>
          <summary>Debug — Request, REST, SQL, Prompt & Raw JSON</summary>
          <div style="margin:.5rem 0 .25rem;font-weight:600">Request URL</div>
          <div class="requrl" id="reqUrl">—</div>

          <div style="margin:.8rem 0 .25rem;font-weight:600">Supabase REST URL</div>
          <div class="requrl" id="restUrl">—</div>

          <div style="margin:.8rem 0 .25rem;font-weight:600">SQL (approximate)</div>
          <pre id="sqlText">—</pre>

          <div style="margin:.8rem 0 .25rem;font-weight:600">Prompt (exact, sent to Gemini)</div>
          <pre id="promptText">—</pre>

          <div style="margin:.8rem 0 .25rem;font-weight:600">Response JSON</div>
          <pre id="raw"></pre>
        </details>
      </section>
    </div>
  </main>

  <script>
    // Your Apps Script endpoint
    const ENDPOINT = "https://script.google.com/macros/s/AKfycbyvzIgN1uiRtnQh9SkjHo8ADtm66NrX2b1uIWr_vQ6XweQZvu1r9izXIVtPWzF7SuDZ/exec";

    const form = document.getElementById('qf');
    const btn = document.getElementById('askBtn');
    const out = document.getElementById('answer');
    const src = document.getElementById('sources');
    const raw = document.getElementById('raw');
    const filt = document.getElementById('filters');
    const buildTag = document.getElementById('buildTag');
    const reqUrlEl = document.getElementById('reqUrl');
    const restUrlEl = document.getElementById('restUrl');
    const sqlTextEl = document.getElementById('sqlText');
    const promptTextEl = document.getElementById('promptText');

    const speedSel = document.getElementById('speed');
    const limitHidden = document.getElementById('limit');

    // Chat
    const chatToggle = document.getElementById('chat');
    const chatBox = document.getElementById('chatBox');
    const newChatBtn = document.getElementById('newChat');
    const threadDisplay = document.getElementById('threadDisplay');

    const speedMap = { fast: 50, medium: 100, slow: 200 };
    function applySpeed(){ limitHidden.value = String(speedMap[speedSel.value] || 50); }
    speedSel.addEventListener('change', applySpeed);
    applySpeed();

    function getThread(){ return localStorage.getItem('tfa_chat_thread') || ''; }
    function setThread(id){ localStorage.setItem('tfa_chat_thread', id); threadDisplay.textContent = 'Thread: ' + id; }
    function clearThread(){ localStorage.removeItem('tfa_chat_thread'); threadDisplay.textContent = 'Thread: —'; }
    function uuid(){ return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c => (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)); }

    function addMsg(role, text){
      const div = document.createElement('div');
      div.className = 'msg ' + (role === 'user' ? 'user' : 'assistant');
      div.textContent = text;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }
    function showChat(on){
      chatBox.hidden = !on;
      if (on && !getThread()){ setThread(uuid()); }
      if (!on) clearThread();
    }
    (function init(){
      const existing = getThread();
      if (existing){ chatToggle.checked = true; showChat(true); setThread(existing); }
    })();
    newChatBtn.addEventListener('click', ()=>{ setThread(uuid()); chatBox.innerHTML = ''; });
    chatToggle.addEventListener('change', ()=> showChat(chatToggle.checked));

    // ---------- Answer formatting ----------
    function escapeHtml(s){
      return s.replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    }
    function formatAnswer(plain){
      if (!plain) return "";
      // Normalize line breaks
      let t = plain.replace(/\r\n/g, "\n").trim();
      // If bullets appear inline like "… discussed. - Point - Point", ensure they break lines
      t = t.replace(/([^\n])\s-\s/g, "$1\n- ");
      const lines = t.split("\n");
      let html = "";
      let inList = false;

      const flushP = (buf) => {
        const s = buf.join(" ").trim();
        if (s) html += `<p>${escapeHtml(s)}</p>`;
        buf.length = 0;
      };

      const pbuf = [];
      for (const line of lines){
        const l = line.trim();
        if (l.startsWith("- ")){
          if (pbuf.length) flushP(pbuf);
          if (!inList){ html += "<ul>"; inList = true; }
          html += `<li>${escapeHtml(l.slice(2).trim())}</li>`;
        } else {
          if (inList){ html += "</ul>"; inList = false; }
          if (l) pbuf.push(l);
        }
      }
      if (inList) html += "</ul>";
      if (pbuf.length) flushP(pbuf);
      return html || "<p>(no answer)</p>";
    }

    // ---------- Request/Render ----------
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      applySpeed();
      btn.disabled = true;
      out.textContent = "Working…";
      src.innerHTML = "";
      raw.textContent = "";
      filt.textContent = "Filters — …";
      restUrlEl.textContent = "—";
      sqlTextEl.textContent = "—";
      promptTextEl.textContent = "—";

      const fd = new FormData(form);
      const params = new URLSearchParams();
      ["from","to","countries","type","topic","question","style","limit"].forEach(k=>{
        const v = (fd.get(k) ?? "").toString();
        params.set(k, v);
      });

      if (chatToggle.checked){
        const thread = getThread() || uuid();
        setThread(thread);
        params.set("chat","1");
        params.set("thread", thread);
      }

      params.set("ts", Date.now().toString());
      const url = `${ENDPOINT}?${params.toString()}`;
      reqUrlEl.textContent = url;

      const userQ = (fd.get('question') || '').toString();
      if (chatToggle.checked && userQ) addMsg('user', userQ);

      try {
        const res = await fetch(url);
        const data = await res.json();

        if (data.build) buildTag.textContent = data.build;

        if (data.error) {
          out.innerHTML = `<span class="muted">Error:</span> ${data.error}` + (data.detail ? `<div class="muted">${escapeHtml(data.detail)}</div>` : "");
          raw.textContent = JSON.stringify(data, null, 2);
          if (data.debug?.rest) restUrlEl.textContent = data.debug.rest;
          if (data.debug?.sql)  sqlTextEl.textContent = data.debug.sql;
          if (data.debug?.prompt) promptTextEl.textContent = data.debug.prompt;
          return;
        }

        // Render answer nicely
        out.innerHTML = formatAnswer(data.answer || "");

        raw.textContent = JSON.stringify(data, null, 2);
        if (data.debug?.rest) restUrlEl.textContent = data.debug.rest;
        if (data.debug?.sql)  sqlTextEl.textContent = data.debug.sql;
        if (data.debug?.prompt) promptTextEl.textContent = data.debug.prompt;

        if (data.filters) {
          const { from, to, countries, type, topic, limit, style } = data.filters;
          const parts = [];
          if (from) parts.push(`from: ${from}`);
          if (to) parts.push(`to: ${to}`);
          if (countries && countries.length) parts.push(`countries: ${countries.join(", ")}`);
          if (type) parts.push(`type: ${type}`);
          if (topic) parts.push(`topic: ${topic}`);
          parts.push(`limit: ${limit}`);
          if (style) parts.push(`style: ${style}`);
          filt.textContent = parts.length ? "Filters — " + parts.join(" | ") : "Filters — none";
        } else {
          filt.textContent = "Filters — none";
        }

        // Sources with robust links
        if (Array.isArray(data.sources) && data.sources.length) {
          const list = data.sources.map(s=>{
            const meta = [s.date, s.type, s.countries].filter(Boolean).join(" · ");
            let linkHtml = "";
            if (s.url && /^https?:\/\//i.test(s.url)) {
              const safe = encodeURI(s.url);
              linkHtml = ` — <a href="${safe}" target="_blank" rel="noopener noreferrer">link</a>`;
            }
            return `<li>${escapeHtml(s.title || "(untitled)")} ${meta?`<span class="muted">(${escapeHtml(meta)})</span>`:""}${linkHtml}</li>`;
          }).join("");
          src.innerHTML = `<h4 style="margin:.8rem 0 .3rem">Sources</h4><ul>${list}</ul>`;
        } else {
          src.innerHTML = "";
        }

        if (chatToggle.checked && data.answer) addMsg('assistant', data.answer);
      } catch (err) {
        out.innerHTML = `<span class="muted">Network error:</span> ${escapeHtml(err.message || String(err))}`;
        filt.textContent = "Filters — network error";
      } finally {
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>
