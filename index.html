<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Partner Insights 1.0</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light" />
  <style>
    :root{
      /* Teach For All–inspired palette (override these with official hexes when you have them) */
      --tfa-primary:  #8B1E3F;  /* deep burgundy */
      --tfa-secondary:#007C89;  /* teal */
      --tfa-accent:   #F26B5B;  /* coral */
      --tfa-bg:       #ffffff;  /* page background */
      --tfa-surface:  #f7f7f8;  /* cards */
      --tfa-border:   #e5e7eb;  /* borders */
      --tfa-text:     #0f172a;  /* slate-900 */
      --tfa-muted:    #475569;  /* slate-600 */
    }
    .bg-grid {
      background-image: linear-gradient(to right, rgba(16,24,40,.04) 1px, transparent 1px),
                        linear-gradient(to bottom, rgba(16,24,40,.04) 1px, transparent 1px);
      background-size: 24px 24px;
    }
  </style>
</head>
<body class="h-full bg-[var(--tfa-bg)] text-[var(--tfa-text)] bg-grid">
  <div class="mx-auto max-w-6xl p-6">
    <header class="mb-8 flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-semibold tracking-tight">Partner Insights 1.0</h1>
        <p class="text-sm text-[var(--tfa-muted)] mt-1">Filter Supabase → Ask Gemini → See answers with sources.</p>
      </div>
      <span class="hidden sm:inline-flex items-center rounded-full border border-[var(--tfa-border)] px-3 py-1 text-xs text-[var(--tfa-muted)]">v1.0</span>
    </header>

    <div class="grid lg:grid-cols-2 gap-6">
      <section class="rounded-2xl border border-[var(--tfa-border)] bg-[var(--tfa-surface)] shadow-sm">
        <div class="p-6">
          <h2 class="text-lg font-medium">Query Builder</h2>
          <p class="text-sm text-[var(--tfa-muted)] mb-4">Enter filters and an optional custom prompt. We’ll POST to your Zapier hook.</p>

          <form id="queryForm" class="space-y-5">
            <div>
              <label for="countries" class="block text-sm font-medium">Countries</label>
              <div class="mt-1 flex items-center gap-2">
                <input id="countries" type="text" inputmode="text" placeholder="Albania, Latvia"
                       class="w-full rounded-xl border border-[var(--tfa-border)] bg-white px-3 py-2 text-sm placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-[var(--tfa-primary)]/30" />
                <button type="button" id="pickCountries" class="rounded-xl border border-[var(--tfa-border)] px-3 py-2 text-xs text-[var(--tfa-text)] hover:bg-white">Pick</button>
              </div>
              <p class="text-xs text-[var(--tfa-muted)] mt-1">Comma-separated. Click <span class="font-medium">Pick</span> to select from a list.</p>
              <div id="countryChips" class="mt-2 flex flex-wrap gap-2"></div>
            </div>

            <div class="grid grid-cols-2 gap-3">
              <div>
                <label for="from" class="block text-sm font-medium">From</label>
                <input id="from" type="date" class="mt-1 w-full rounded-xl border border-[var(--tfa-border)] bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[var(--tfa-primary)]/30" />
              </div>
              <div>
                <label for="to" class="block text-sm font-medium">To</label>
                <input id="to" type="date" class="mt-1 w-full rounded-xl border border-[var(--tfa-border)] bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[var(--tfa-primary)]/30" />
              </div>
            </div>

            <div>
              <label for="topic" class="block text-sm font-medium">Topic (keyword)</label>
              <input id="topic" type="text" placeholder="funding, TACL, grant" class="mt-1 w-full rounded-xl border border-[var(--tfa-border)] bg-white px-3 py-2 text-sm placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-[var(--tfa-primary)]/30" />
            </div>

            <div>
              <label for="prompt" class="block text sm font-medium">Custom prompt (optional)</label>
              <textarea id="prompt" rows="4" placeholder="Write a brief update for leadership..." class="mt-1 w-full rounded-xl border border-[var(--tfa-border)] bg-white px-3 py-2 text-sm placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-[var(--tfa-primary)]/30"></textarea>
            </div>

            <div class="flex items-center gap-3 pt-2">
              <button id="run" type="submit" class="inline-flex items-center gap-2 rounded-xl bg-[var(--tfa-primary)] px-4 py-2 text-sm font-medium text-white shadow hover:brightness-110 focus:outline-none focus:ring-2 focus:ring-[var(--tfa-primary)]/40">
                <svg id="runSpinner" class="hidden h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>
                <span>Run</span>
              </button>
              <button type="button" id="resetBtn" class="rounded-xl border border-[var(--tfa-border)] px-4 py-2 text-sm hover:bg-white">Reset</button>
            </div>
          </form>
        </div>
      </section>

      <section class="rounded-2xl border border-[var(--tfa-border)] bg-[var(--tfa-surface)] shadow-sm">
        <div class="p-6">
          <h2 class="text-lg font-medium mb-3">Answer</h2>
          <div id="answer" class="min-h-[140px] whitespace-pre-wrap rounded-xl border border-[var(--tfa-border)] bg-white p-4"></div>

          <h3 class="text-sm font-medium mt-6 mb-2">Sources</h3>
          <div class="overflow-auto rounded-xl border border-[var(--tfa-border)] bg-white">
            <table class="min-w-full text-sm">
              <thead class="bg-[color-mix(in srgb,var(--tfa-primary),white 90%)] text-[var(--tfa-text)]/90">
                <tr>
                  <th class="px-3 py-2 text-left">Date</th>
                  <th class="px-3 py-2 text-left">Countries</th>
                  <th class="px-3 py-2 text-left">Headline</th>
                </tr>
              </thead>
              <tbody id="sources" class="divide-y divide-[var(--tfa-border)]"></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>

    <dialog id="countryModal" class="rounded-2xl border border-[var(--tfa-border)] bg-[var(--tfa-surface)] p-0 text-[var(--tfa-text)] shadow-xl w-full max-w-lg">
      <form method="dialog">
        <div class="p-5 border-b border-[var(--tfa-border)] flex items-center justify-between">
          <h3 class="text-base font-medium">Pick countries</h3>
          <button class="rounded-lg px-2 py-1 text-[var(--tfa-text)]/70 hover:bg-white" value="cancel">✕</button>
        </div>
        <div class="p-5 space-y-2 max-h-[50vh] overflow-auto" id="countryList">
          </div>
        <div class="p-4 border-t border-[var(--tfa-border)] flex justify-end gap-2">
          <button class="rounded-xl border border-[var(--tfa-border)] px-4 py-2 text-sm" value="cancel">Cancel</button>
          <button id="applyCountries" class="rounded-xl bg-[var(--tfa-primary)] px-4 py-2 text-sm font-medium text-white" value="default">Apply</button>
        </div>
      </form>
    </dialog>

    <div id="toast" class="fixed bottom-4 right-4 hidden rounded-xl bg-[var(--tfa-text)]/90 px-4 py-3 text-sm text-white shadow-lg"></div>
  </div>

  <script>
    // --- Simple country list (edit or fetch dynamically) ---
    const COUNTRY_OPTIONS = [
      'Albania','Armenia','Austria','Bulgaria','Czech Republic','Georgia','Hungary','Israel','Italy','Kosovo','Latvia','Lithuania','Moldova','Portugal','Romania','Serbia','Slovakia','Spain','Ukraine','UK'
    ];

    const el = (id) => document.getElementById(id);

    function showToast(msg, ms = 2200) {
      const t = el('toast');
      t.textContent = msg;
      t.classList.remove('hidden');
      setTimeout(() => t.classList.add('hidden'), ms);
    }

    function parseCountries(input) {
      return input.split(',').map(s => s.trim()).filter(Boolean);
    }

    function renderChips(values){
      const wrap = el('countryChips');
      wrap.innerHTML = '';
      (values||[]).forEach(v => {
        const chip = document.createElement('span');
        chip.className = 'inline-flex items-center gap-1 rounded-full bg-[color-mix(in srgb,var(--tfa-primary),white 85%)] text-[var(--tfa-text)]/80 px-2.5 py-1 text-xs';
        chip.textContent = v;
        const x = document.createElement('button');
        x.type = 'button';
        x.className = 'ml-1 text-[var(--tfa-text)]/60 hover:text-[var(--tfa-text)]';
        x.textContent = '×';
        x.onclick = () => {
          const arr = parseCountries(el('countries').value).filter(c => c !== v);
          el('countries').value = arr.join(', ');
          renderChips(arr);
        };
        chip.appendChild(x);
        wrap.appendChild(chip);
      });
    }

    function renderSources(rows) {
      const tbody = el('sources');
      tbody.innerHTML = '';
      (rows || []).forEach(r => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-[color-mix(in srgb,var(--tfa-primary),white 96%)]';
        tr.innerHTML = `<td class="px-3 py-2 align-top">${r.date ?? ''}</td>
                         <td class="px-3 py-2 align-top">${r.countries ?? ''}</td>
                         <td class="px-3 py-2 align-top">${r.headline ?? ''}</td>`;
        tbody.appendChild(tr);
      });
    }

    // --- Country modal logic ---
    const modal = el('countryModal');
    const list = el('countryList');
    el('pickCountries').addEventListener('click', () => {
      list.innerHTML = COUNTRY_OPTIONS.map(c => `
        <label class="flex items-center gap-2 text-sm">
          <input type="checkbox" value="${c}" class="accent-[var(--tfa-primary)]">
          <span>${c}</span>
        </label>`).join('');
      modal.showModal();
    });
    el('applyCountries').addEventListener('click', (e) => {
      e.preventDefault();
      const selected = Array.from(list.querySelectorAll('input:checked')).map(i => i.value);
      el('countries').value = selected.join(', ');
      renderChips(selected);
      modal.close();
    });

    // Keep chips in sync with free-typed input
    el('countries').addEventListener('input', () => renderChips(parseCountries(el('countries').value)));

    // --- Submit logic ---
    el('queryForm').addEventListener('submit', async (ev) => {
      ev.preventDefault();

      const workerUrl = 'https://ofzdnwdxopporgbgrocg.supabase.co/functions/v1/partner-insights-api';

      const payload = {
        countries: parseCountries(el('countries').value),
        from: el('from').value || null,
        to: el('to').value || null,
        topic: el('topic').value || null,
        prompt: el('prompt').value || null
      };

      const btn = el('run');
      const spinner = el('runSpinner');
      btn.disabled = true; spinner.classList.remove('hidden');
      el('answer').textContent = '';
      renderSources([]);

      try {
        const res = await fetch(workerUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();

        const answer = (data && (data.answer || data.result || data.output)) || '(No answer)';
        el('answer').textContent = answer;
        renderSources(data && (data.sources || data.rows || []));
      } catch(err) {
        el('answer').textContent = 'Error: ' + err.message;
        showToast('Request failed. Check console for details.');
        console.error(err);
      } finally {
        btn.disabled = false; spinner.classList.add('hidden');
      }
    });

    el('resetBtn').addEventListener('click', () => {
      ['countries','from','to','topic','prompt'].forEach(id => el(id).value = '');
      el('answer').textContent = '';
      renderSources([]);
      renderChips([]);
    });
  </script>
</body>
</html>
