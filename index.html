/* ===== Script Properties (Project Settings ▸ Script properties) =====
   SUPABASE_URL          = https://ofzdnwdxopporgbgrocg.supabase.co
   SUPABASE_SERVICE_ROLE = <your service_role key>
   GEMINI_API_KEY        = <your Gemini API key>
   TABLE_NAME            = meetings
==================================================================== */

const BUILD = "tfa-query-v7 (2025-08-17)";

// JSON helper
function json_(obj){ return ContentService.createTextOutput(JSON.stringify(obj||{})).setMimeType(ContentService.MimeType.JSON); }

// Route
function doGet(e){ return handle_(e); }
function doPost(e){ return handle_(e); }

function handle_(e){
  try{
    const props = PropertiesService.getScriptProperties().getProperties();
    const SUPABASE_URL = String(props.SUPABASE_URL||"").replace(/\s+/g,"").replace(/\/+$/,"");
    const SRK  = String(props.SUPABASE_SERVICE_ROLE||"");
    const GEM  = String(props.GEMINI_API_KEY||"");
    const TABLE= String(props.TABLE_NAME||"meetings");

    if(!/^https:\/\/[^.]+\.supabase\.co$/.test(SUPABASE_URL)) return json_({build:BUILD,error:"Missing/invalid SUPABASE_URL"});
    if(!SRK || !GEM) return json_({build:BUILD,error:"Missing SUPABASE_SERVICE_ROLE or GEMINI_API_KEY"});

    // inputs
    let body={}; const p=(e&&e.parameter)||{};
    if(e&&e.postData&&e.postData.contents&&e.postData.type==="application/json"){ try{ body=JSON.parse(e.postData.contents||"{}"); }catch(_){} }
    const get=(k,d="")=>{ const v=(body[k]!==undefined?body[k]:p[k]); return v!=null?String(v):d; };

    const from = get("from").trim();
    const to   = get("to").trim();
    const countriesCSV = get("countries").trim();
    const topic= get("topic").trim();
    const question = get("question").trim();
    const style= get("style","short").toLowerCase();              // "short" | "normal"
    const limit= Math.max(1, Math.min(10, Number(get("limit","5"))||5));

    // Type (All / Zoom Meeting / Email / Note)
    let typeRaw = get("type","").trim();
    let type = "";
    if(typeRaw){
      const t=typeRaw.toLowerCase();
      if(t==="email") type="Email";
      else if(t==="note"||t==="notes") type="Note";
      else if(t==="zoom meeting"||t==="zoom"||t==="meeting") type="Zoom Meeting";
      else type = typeRaw;
    }

    if(!question) return json_({build:BUILD,error:"Missing 'question'."});

    const countries = countriesCSV ? countriesCSV.split(",").map(s=>s.trim()).filter(Boolean) : [];

    // ---- Supabase query ----
    const selectCols = [
      "id","date","type","countries","headline","sender","recipients",
      "summary","source_file","created_at","updated_at"
    ].join(",");

    const qp=[];
    qp.push(`select=${encodeURIComponent(selectCols)}`);
    qp.push(`order=date.desc.nullslast`);
    qp.push(`limit=${limit}`);
    if(from) qp.push(`date=gte.${from}`);
    if(to)   qp.push(`date=lte.${to}`);
    if(type) qp.push(`type=eq.${encodeURIComponent(type)}`);

    const ors=[];
    if(countries.length){
      ors.push(...countries.map(c=>`countries.ilike.*${encodeURIComponent(c)}*`));
    }
    if(topic){
      ors.push(`summary.ilike.*${encodeURIComponent(topic)}*`);
      ors.push(`headline.ilike.*${encodeURIComponent(topic)}*`);
    }
    if(ors.length) qp.push(`or=(${ors.join(",")})`);

    const url = `${SUPABASE_URL}/rest/v1/${encodeURIComponent(TABLE)}?${qp.join("&")}`;
    const supRes = UrlFetchApp.fetch(url,{method:"get",headers:{
      "apikey":SRK,"Authorization":`Bearer ${SRK}`,"Accept":"application/json"
    },muteHttpExceptions:true});
    const supCode = supRes.getResponseCode();
    if(supCode>=400) return json_({build:BUILD,error:"Supabase error",status:supCode,detail:supRes.getContentText(),request:url});
    const rows = JSON.parse(supRes.getContentText()||"[]");

    // ---- Prompt ----
    const ctx = rows.map(r=>{
      const ctry = (r.countries||"None").toString();
      const snip = [r.summary,r.headline,r.sender,r.recipients].filter(Boolean).join(" · ");
      return `- title: ${r.headline||"(untitled)"}\n  date: ${r.date||"—"}  ·  type: ${r.type||"—"}  ·  countries: ${ctry}\n  snippet: ${snip.substring(0,280)}`;
    }).join("\n\n");

    const filtersSummary = [
      `from=${from||"—"}`, `to=${to||"—"}`,
      `countries=${countries.length?countries.join(", "):"—"}`,
      `type=${type||"All"}`, `topic=${topic||"—"}`, `limit=${limit}`
    ].join("; ");

    const prompt =
`You are a helpful Teach For All support agent. Answer in English only.
Use ONLY the CONTEXT below (from the Supabase '${TABLE}' table). Do not invent facts.
If the context is insufficient, say what is missing and ask for the smallest clarification possible.

Style: ${style}
- short  → concise bullets (3–6), direct wording, no fluff.
- normal → 1–3 short paragraphs, then a compact bullet list.

When useful, reference items by title and/or date. Prefer recent items.
Respect all provided filters (including 'type').

QUESTION:
${question}

FILTERS:
${filtersSummary}

CONTEXT (each item is one row from Supabase):
${ctx || "(no rows in context)"}

TASK:
1) Answer the QUESTION using only the CONTEXT.
2) If context is missing, state exactly what is missing.
3) Keep the output in ${style} format.`;

    // ---- Gemini ----
    const gemUrl="https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent";
    const payload={contents:[{role:"user",parts:[{text:prompt}]}]};
    const gemRes=UrlFetchApp.fetch(`${gemUrl}?key=${encodeURIComponent(GEM)}`,{
      method:"post",contentType:"application/json",payload:JSON.stringify(payload),muteHttpExceptions:true
    });
    const gemCode=gemRes.getResponseCode();
    if(gemCode>=400) return json_({build:BUILD,error:"Gemini error",status:gemCode,detail:gemRes.getContentText()});
    const gemJson=JSON.parse(gemRes.getContentText()||"{}");
    const answer=(gemJson.candidates&&gemJson.candidates[0]&&gemJson.candidates[0].content&&gemJson.candidates[0].content.parts&&gemJson.candidates[0].content.parts[0]&&gemJson.candidates[0].content.parts[0].text)||"(no answer)";

    const sources = rows.slice(0,limit).map(r=>({
      title:r.headline||"(untitled)", date:r.date||null, type:r.type||null, countries:r.countries||null, url:r.source_file||null
    }));

    return json_({
      build:BUILD,
      answer,
      sources,
      filters:{ from:from||null, to:to||null, countries, type:type||null, topic:topic||null, limit, style }
    });
  }catch(err){
    return json_({build:BUILD,error:"Server error",detail:String(err&&err.stack||err)});
  }
}
