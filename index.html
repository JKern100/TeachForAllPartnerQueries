<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Teach For All — Knowledge Q&A (client-ui)</title>
  <style>
    :root {
      --bg: #0f1220;
      --panel: #171a2a;
      --text: #e9ecff;
      --muted: #9aa3c7;
      --accent: #7aa2ff;
      --accent-2: #a8ffef;
      --danger: #ff7a7a;
      --ok: #6ee7b7;
      --border: #232743;
    }
    html, body { background: var(--bg); color: var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
    .wrap { max-width: 1050px; margin: 32px auto 120px; padding: 0 16px; }
    h1 { font-size: 26px; margin: 0 0 20px; letter-spacing: .2px }
    .subtle { color: var(--muted); font-size: 12px; margin-left: 8px; padding: 2px 6px; background: #1e2238; border-radius: 10px; vertical-align: middle;}
    .card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 18px; margin-bottom: 16px; }
    label { display:block; font-size: 12px; color: var(--muted); margin: 14px 0 6px; }
    input[type="text"], input[type="date"], select, textarea {
      width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); background: #0f1330; color: var(--text);
    }
    textarea { min-height: 120px; resize: vertical; }
    .row { display:flex; gap:14px; }
    .row > div { flex:1; }
    .row-3 > div { flex: 1 1 33.3%; }
    .btns { display:flex; gap:10px; margin-top: 14px; }
    button {
      padding: 10px 14px; border-radius: 8px; border: 1px solid var(--border);
      background: #1e2448; color: var(--text); cursor: pointer;
    }
    button.primary { background: #2a3470; border-color:#384196; }
    button:disabled { opacity: .6; cursor: default; }
    .muted { color: var(--muted); }
    .answer { background: #0e1233; border: 1px solid var(--border); border-radius: 10px; padding: 16px; min-height: 80px }
    .error { color: var(--danger); }
    details summary { cursor:pointer; color: var(--muted); }
    ul.clean { margin: 6px 0 0 18px; }
    .tag { display:inline-block; font-size: 12px; padding: 2px 8px; border:1px solid var(--border); border-radius: 999px; color: var(--muted); margin-right:6px;}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Teach For All — Knowledge Q&amp;A <span class="subtle">client-ui</span></h1>

    <div class="card">
      <div class="row row-3">
        <div>
          <label>From date</label>
          <input id="from" type="date" />
        </div>
        <div>
          <label>To date</label>
          <input id="to" type="date" />
        </div>
        <div>
          <label>Quick ranges</label>
          <div class="btns">
            <button onclick="qrange(7)">Past 7 days</button>
            <button onclick="qrange(31)">Past month</button>
            <button onclick="qrange(92)">Last 3 months</button>
            <button onclick="clearDates()">Clear dates</button>
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Type</label>
          <select id="type">
            <option value="all">All (default)</option>
            <option value="Zoom Meeting">Zoom Meeting</option>
          </select>
        </div>
        <div>
          <label>Countries (comma-separated)</label>
          <input id="countries" type="text" placeholder="e.g., Portugal, Spain" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Topic (optional)</label>
          <input id="topic" type="text" placeholder="standards, onboarding, budget…" />
        </div>
        <div>
          <label>Response speed</label>
          <select id="speed">
            <option value="30">Fast (~30 rows)</option>
            <option value="100" selected>Medium (~100 rows)</option>
            <option value="300">Max (300 rows)</option>
          </select>
        </div>
      </div>

      <label>Question</label>
      <textarea id="question" placeholder="Ask your question… e.g., What was my last meeting with Bea about?"></textarea>

      <div class="row">
        <div>
          <label>Answer style</label>
          <select id="style">
            <option value="normal" selected>normal</option>
            <option value="short">short</option>
          </select>
        </div>
      </div>

      <div class="btns">
        <button id="askBtn" class="primary" onclick="ask()">Ask</button>
        <button onclick="resetForm()">Reset</button>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px">Answer</h3>
      <div id="answer" class="answer"></div>
      <div id="err" class="error" style="margin-top:8px;"></div>

      <details style="margin-top:14px">
        <summary>Debug — Request, REST, SQL, Prompt &amp; Raw JSON</summary>
        <div id="debug" class="muted" style="white-space:pre-wrap; font-size:12px; margin-top:10px;"></div>
      </details>
    </div>

    <div class="card">
      <h3 style="margin:0 0 6px">Sources</h3>
      <div id="sources" class="muted"></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px">Add Note to Supabase</h3>
      <label>Note text</label>
      <textarea id="note" placeholder="Write a quick note to save…"></textarea>
      <div class="row">
        <div>
          <label>Optional: Meeting ID</label>
          <input id="meeting_id" type="text" placeholder="e.g., r1" />
        </div>
        <div>
          <label>Optional: Author</label>
          <input id="author" type="text" placeholder="Your name or email" />
        </div>
      </div>
      <div class="btns">
        <button id="saveNoteBtn" class="primary" onclick="saveNote()">Save note</button>
        <span class="muted">Tip: filters, dates, and question are saved in <code>meta</code>.</span>
      </div>
      <div id="noteMsg" class="muted" style="margin-top:8px;"></div>
    </div>
  </div>

  <script>
    // ========= CONFIG =========
    const GAS_BASE = "https://script.google.com/macros/s/AKfycbyvzIgN1uiRtnQh9SkjHo8ADtm66NrX2b1uIWr_vQ6XweQZvu1r9izXIVtPWzF7SuDZ/exec"; // <-- replace if you redeploy

    // ========= JSONP =========
    function jsonp(baseUrl, params, timeoutMs = 20000) {
      return new Promise((resolve, reject) => {
        const cbName = "__cb" + Date.now() + "_" + Math.floor(Math.random() * 1e6);
        const qs = new URLSearchParams(params);
        qs.set("callback", cbName);
        const full = baseUrl + (baseUrl.includes("?") ? "&" : "?") + qs.toString();

        let done = false;
        const cleanup = () => {
          done = true;
          try { delete window[cbName]; } catch(e){}
          try { script.remove(); } catch(e){}
          clearTimeout(t);
        };

        window[cbName] = (data) => { if (done) return; cleanup(); resolve(data); };

        const t = setTimeout(() => { if (done) return; cleanup(); reject(new Error("JSONP timeout")); }, timeoutMs);

        const script = document.createElement("script");
        script.src = full;
        script.onerror = () => { if (done) return; cleanup(); reject(new Error("JSONP network error")); };
        document.head.appendChild(script);
      });
    }

    // ========= UI HELPERS =========
    function todayIso(d = new Date()) { return d.toISOString().slice(0,10); }
    function daysAgoIso(n) { const d = new Date(); d.setDate(d.getDate() - n); return d.toISOString().slice(0,10); }

    function qrange(n) {
      document.getElementById("from").value = daysAgoIso(n);
      document.getElementById("to").value = todayIso();
    }
    function clearDates() {
      document.getElementById("from").value = "";
      document.getElementById("to").value = "";
    }
    function resetForm() {
      document.getElementById("question").value = "";
      document.getElementById("topic").value = "";
      document.getElementById("countries").value = "";
      document.getElementById("type").value = "all";
      document.getElementById("speed").value = "100";
      document.getElementById("style").value = "normal";
      clearDates();
      setAnswer("", "");
      setSources([]);
      setDebug("");
      document.getElementById("note").value = "";
      document.getElementById("meeting_id").value = "";
      document.getElementById("author").value = "";
      document.getElementById("noteMsg").textContent = "";
    }

    function setAnswer(html, err) {
      document.getElementById("answer").innerHTML = html || "";
      document.getElementById("err").textContent = err || "";
    }
    function setSources(srcs) {
      const el = document.getElementById("sources");
      if (!srcs || !srcs.length) { el.innerHTML = "<span class='muted'>—</span>"; return; }
      el.innerHTML = srcs.map(s => {
        const bits = [s.date, s.type, s.countries].filter(Boolean).join(" · ");
        return `<div><span class="tag">${bits||"source"}</span> ${escapeHtml(s.title||"")}</div>`;
      }).join("");
    }
    function setDebug(s) { document.getElementById("debug").textContent = s || ""; }
    function escapeHtml(x) { return (x||"").replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

    function collectFilters() {
      return {
        from: document.getElementById("from").value || "",
        to: document.getElementById("to").value || "",
        type: document.getElementById("type").value || "all",
        countries: document.getElementById("countries").value || "",
        topic: document.getElementById("topic").value || "",
        limit: document.getElementById("speed").value || "100",
        style: document.getElementById("style").value || "normal",
        question: document.getElementById("question").value || ""
      };
    }

    // ========= ACTIONS =========
    async function ask() {
      const btn = document.getElementById("askBtn");
      btn.disabled = true; setAnswer("", ""); setDebug(""); setSources([]);

      const p = collectFilters();
      if (!p.question.trim()) { setAnswer("", "Please enter a question."); btn.disabled = false; return; }

      try {
        const data = await jsonp(GAS_BASE, { action: "ask", ...p });
        if (!data || data.ok === false) {
          setAnswer("", "Error: " + (data && data.error ? data.error : "Unknown"));
        } else {
          setAnswer(data.answer || "", "");
          setSources(data.sources || []);
          const dbg = [
            "Request URL:\n" + GAS_BASE,
            "",
            "Supabase REST URL:\n" + (data.debug && data.debug.rest ? data.debug.rest : ""),
            "",
            "SQL (approximate):\n" + (data.debug && data.debug.sql_approx ? data.debug.sql_approx : ""),
            "",
            "Prompt (exact, sent to Gemini):\n" + (data.debug && data.debug.prompt ? data.debug.prompt : "")
          ].join("\n");
          setDebug(dbg);
        }
      } catch (err) {
        setAnswer("", "Error: " + err.message);
      } finally {
        btn.disabled = false;
      }
    }

    async function saveNote() {
      const btn = document.getElementById("saveNoteBtn");
      btn.disabled = true;
      const noteMsg = document.getElementById("noteMsg");
      noteMsg.textContent = "";

      const p = collectFilters();
      const note = document.getElementById("note").value || "";
      const meeting_id = document.getElementById("meeting_id").value || "";
      const author = document.getElementById("author").value || "";

      if (!note.trim()) { noteMsg.textContent = "Please type a note."; btn.disabled = false; return; }

      try {
        const data = await jsonp(GAS_BASE, {
          action: "addNote",
          note,
          meeting_id,
          author,
          // pass filters/meta too:
          from: p.from, to: p.to, type: p.type, countries: p.countries,
          topic: p.topic, style: p.style, question: p.question
        });

        if (!data || data.ok === false) {
          noteMsg.textContent = "Error saving note: " + (data && data.error ? data.error : "Unknown");
        } else {
          const tbl = data.result && data.result.table || "?";
          noteMsg.textContent = "Saved to table “" + tbl + "”.";
        }
      } catch (err) {
        noteMsg.textContent = "Error: " + err.message;
      } finally {
        btn.disabled = false;
      }
    }

    // ========= INIT =========
    // start with last 30 days (like your earlier default)
    qrange(30);
  </script>
</body>
</html>
