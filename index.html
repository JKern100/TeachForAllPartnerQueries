<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Teach For All — Knowledge Q&A</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0f1222; --panel:#171a2b; --panel-2:#1b1f33; --text:#e9ecf5; --muted:#a9afc6;
  --accent:#7767ff; --accent-2:#9d8aff; --ok:#1fb981; --err:#ff5d7a; --border:#242742;
}
*{box-sizing:border-box}
body{
  margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--text); background:radial-gradient(1200px 600px at 20% -10%, #1a1e35 0%, #0f1222 60%);
}
.wrap{max-width:1100px; margin:24px auto; padding:0 16px}
header{display:flex; align-items:center; gap:10px; margin-bottom:18px}
h1{font-size:28px; margin:0}
.chip{font-size:12px; background:#222749; color:#b8c0ff; padding:4px 8px; border-radius:999px}
.card{background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:18px; margin-bottom:16px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
.grid-2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
.grid-3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px}
.grid-auto{display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:12px}
label{display:block; font-weight:600; font-size:13px; margin:8px 0 6px; color:var(--muted)}
input,select,textarea{
  width:100%; background:var(--panel-2); color:var(--text);
  border:1px solid var(--border); border-radius:10px; padding:10px 12px; font:inherit; outline:none;
}
textarea{min-height:120px; resize:vertical}
.muted{color:var(--muted); font-size:13px}
.btn{
  display:inline-block; background:linear-gradient(90deg,var(--accent),var(--accent-2));
  color:#fff; border:none; padding:10px 18px; border-radius:10px; font-weight:700; cursor:pointer;
}
.btn.secondary{background:#242742; color:#d7dbf1}
.btn.success{background:linear-gradient(90deg,#1fb981,#15a46f)}
.pills{display:flex; gap:8px; flex-wrap:wrap}
.pill{background:#1e2442; border:1px solid var(--border); color:#c9cff8; padding:8px 10px; border-radius:999px; font-size:13px; cursor:pointer}
.inline{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
.answer{white-space:pre-wrap; line-height:1.55}
.sources ul{margin:6px 0 0 18px}
.ok{color:var(--ok)} .err{color:var(--err)}
.hint{font-size:12px; color:var(--muted); margin-top:6px}
@media (max-width:780px){ .grid-3{grid-template-columns:1fr; } .grid-2{grid-template-columns:1fr;} }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Teach For All — Knowledge Q&A</h1>
    <span class="chip">client-ui + notes</span>
  </header>

  <!-- ===== QUERY CARD ===== -->
  <section class="card" id="q-card">
    <div class="inline" style="justify-content:space-between; margin-bottom:4px">
      <div class="inline" style="gap:12px">
        <label class="inline" style="margin:0; gap:8px">
          <input type="checkbox" id="chatRemember"> Chat mode (remember this thread)
        </label>
        <div class="inline muted" style="gap:6px">Thread: <span id="threadLabel">—</span></div>
      </div>
      <button class="pill" onclick="newChat()">New chat</button>
    </div>

    <div class="grid-3">
      <div>
        <label>From date</label>
        <input id="from" type="date">
      </div>
      <div>
        <label>To date</label>
        <input id="to" type="date">
      </div>
      <div>
        <label>Quick ranges</label>
        <div class="pills">
          <button class="pill" onclick="quickRange(7)">Past 7 days</button>
          <button class="pill" onclick="quickRange(30)">Past month</button>
          <button class="pill" onclick="quickRange(90)">Last 3 months</button>
          <button class="pill" onclick="clearDates()">Clear dates</button>
        </div>
      </div>
    </div>

    <div class="grid-2">
      <div>
        <label>Type</label>
        <select id="type">
          <option value="all" selected>All (default)</option>
          <option>Zoom Meeting</option>
          <option>Email</option>
          <option>Note</option>
        </select>
      </div>
      <div>
        <label>Countries (comma-separated)</label>
        <input id="countries" placeholder="e.g., Portugal, Spain">
      </div>
    </div>

    <div class="grid-2">
      <div>
        <label>Topic (optional)</label>
        <input id="topic" placeholder="standards, onboarding, budget…">
      </div>
      <div>
        <label>Answer style</label>
        <select id="style">
          <option value="normal" selected>normal</option>
          <option value="short">short</option>
        </select>
      </div>
    </div>

    <div>
      <label>Question</label>
      <textarea id="question" placeholder="Ask your question… e.g., What are Italy’s priorities from the last two weeks?"></textarea>
    </div>

    <div class="grid-2" style="align-items:end">
      <div>
        <label>Response speed</label>
        <select id="speed">
          <option value="50">Fast (~50 rows)</option>
          <option value="100" selected>Medium (~100 rows)</option>
          <option value="200">Slower (~200 rows)</option>
        </select>
        <div class="hint">More rows = more context, potentially slower.</div>
      </div>
      <div class="inline" style="justify-content:flex-end">
        <button class="btn secondary" onclick="resetForm()">Reset</button>
        <button class="btn" onclick="ask()">Ask</button>
      </div>
    </div>
  </section>

  <!-- ===== RESULTS ===== -->
  <section class="card">
    <div class="muted" id="filters">Filters — countries: all | type: all | limit: 100 | style: normal | from: — | to: —</div>
    <h3 style="margin:14px 0 6px">Answer</h3>
    <div class="answer" id="answer">—</div>
    <h3 style="margin:18px 0 6px">Sources</h3>
    <div class="sources" id="sources">—</div>

    <details>
      <summary>Debug — Request, REST, SQL, Prompt & Raw JSON</summary>
      <div class="muted" style="margin-top:8px">Request URL</div>
      <pre id="requrl" class="muted" style="white-space:pre-wrap"></pre>
      <div class="muted" style="margin-top:8px">Supabase REST URL</div>
      <pre id="resturl" class="muted" style="white-space:pre-wrap"></pre>
      <div class="muted" style="margin-top:8px">SQL (approximate)</div>
      <pre id="sql" class="muted" style="white-space:pre-wrap"></pre>
      <div class="muted" style="margin-top:8px">Prompt (exact, sent to Gemini)</div>
      <pre id="prompt" class="muted" style="white-space:pre-wrap"></pre>
      <div class="muted" style="margin-top:8px">Response JSON</div>
      <pre id="raw" class="muted" style="white-space:pre-wrap"></pre>
    </details>
  </section>

  <!-- ===== ADD NOTE ===== -->
  <section class="card" id="note-card">
    <h2 style="margin:4px 0 12px">Add note</h2>
    <div class="grid-3">
      <div>
        <label>Date</label>
        <input id="n_date" type="date">
      </div>
      <div>
        <label>Type</label>
        <select id="n_type">
          <option selected>Note</option>
          <option>Zoom Meeting</option>
          <option>Email</option>
        </select>
      </div>
      <div>
        <label>Recipients (optional)</label>
        <input id="n_recipients" placeholder="e.g., Ramona; Alex">
      </div>
    </div>
    <div class="grid-2">
      <div>
        <label>Countries (optional)</label>
        <input id="n_countries" placeholder="e.g., Latvia, Italy">
      </div>
      <div></div>
    </div>
    <div>
      <label>Summary (the note)</label>
      <textarea id="n_summary" placeholder="Write your note…"></textarea>
    </div>
    <div class="inline" style="justify-content:flex-end">
      <div id="n_status" class="muted"></div>
      <button class="btn success" onclick="saveNote()">Save note</button>
    </div>
    <div class="hint">Requires being signed in with your Teach For All Google account in this browser.</div>
  </section>
</div>

<script>
/* ==== CONFIG ==== */
const ENDPOINT = "https://script.google.com/macros/s/AKfycbyvzIgN1uiRtnQh9SkjHo8ADtm66NrX2b1uIWr_vQ6XweQZvu1r9izXlVtPWzF7SuDZ/exec";

/* ==== HELPERS ==== */
const $ = id => document.getElementById(id);
const todayISO = () => new Date().toISOString().slice(0,10);
const STORAGE_THREAD = "tfa.thread";
const STORAGE_REMEMBER = "tfa.thread.remember";

let currentThread = null;

function setThreadLabel(){
  $("threadLabel").textContent = currentThread || "—";
}

/* ==== INIT ==== */
(function init(){
  // default note date
  $("n_date").value = todayISO();

  // restore chat settings
  const remember = localStorage.getItem(STORAGE_REMEMBER) === "1";
  $("chatRemember").checked = remember;
  currentThread = remember ? localStorage.getItem(STORAGE_THREAD) : null;
  setThreadLabel();

  $("chatRemember").addEventListener("change", () => {
    const on = $("chatRemember").checked;
    localStorage.setItem(STORAGE_REMEMBER, on ? "1" : "0");
    if (on && !currentThread) newChat();
    if (!on){ localStorage.removeItem(STORAGE_THREAD); }
  });
})();

/* ==== CHAT THREAD ==== */
function newChat(){
  currentThread = "thr_" + Date.now().toString(36);
  if ($("chatRemember").checked){
    localStorage.setItem(STORAGE_THREAD, currentThread);
  }
  setThreadLabel();
}

/* ==== DATES ==== */
function quickRange(days){
  const to = new Date(); const from = new Date(Date.now()-days*864e5);
  $("from").value = from.toISOString().slice(0,10);
  $("to").value   = to.toISOString().slice(0,10);
}
function clearDates(){ $("from").value=""; $("to").value=""; }

/* ==== FORM === */
function resetForm(){
  ["from","to","countries","topic","question"].forEach(id => $(id).value = "");
  $("type").value="all"; $("style").value="normal"; $("speed").value="100";
  $("answer").textContent="—"; $("sources").textContent="—";
  ["requrl","resturl","sql","prompt","raw"].forEach(id => $(id).textContent = "");
}

/* ==== ASK ==== */
async function ask(){
  const params = new URLSearchParams({
    question: $("question").value || "",
    topic: $("topic").value || "",
    countries: $("countries").value || "",
    type: $("type").value || "all",
    style: $("style").value || "normal",
    limit: $("speed").value || "100",
    from: $("from").value || "",
    to: $("to").value || "",
    thread: currentThread || "",
    ts: "1"
  });
  const url = ENDPOINT + "?" + params.toString();
  $("requrl").textContent = url;
  $("filters").textContent =
    `Filters — countries: ${$("countries").value || "all"} | type: ${$("type").value || "all"} | ` +
    `limit: ${$("speed").value || "100"} | style: ${$("style").value||"normal"} | from: ${$("from").value||"—"} | to: ${$("to").value||"—"}`;

  $("answer").textContent = "Working…";

  try{
    const res = await fetch(url, {method:"GET"});
    const data = await res.json();

    $("answer").innerHTML = data.answer ? data.answer : "—";

    if (data.sources && Array.isArray(data.sources) && data.sources.length){
      const ul = document.createElement("ul");
      data.sources.forEach(s=>{
        const li = document.createElement("li");
        // No live links (per your request)
        li.textContent = `${s.title} (${s.date} · ${s.type} · ${s.countries||"None"})`;
        ul.appendChild(li);
      });
      $("sources").innerHTML = ""; $("sources").appendChild(ul);
    } else {
      $("sources").textContent = "—";
    }

    $("resturl").textContent = data.rest || "";
    $("sql").textContent = data.sql || "";
    $("prompt").textContent = data.prompt || "";
    $("raw").textContent = JSON.stringify(data, null, 2);

  }catch(err){
    $("answer").innerHTML = `<span class="err">Error:</span> ${err.message}`;
    console.error(err);
  }
}

/* ==== INSERT NOTE (no preflight; URL-encoded) ==== */
async function saveNote(){
  const date       = $("n_date").value || todayISO();
  const type       = $("n_type").value || "Note";
  const recipients = $("n_recipients").value || "";
  const countries  = $("n_countries").value || "";
  const summary    = $("n_summary").value.trim();
  const statusEl   = $("n_status");

  if (!summary){
    statusEl.innerHTML = `<span class="err">Please enter a note summary.</span>`;
    return;
  }
  statusEl.textContent = "Saving…";

  try{
    // IMPORTANT: no headers → keep it a simple request (no CORS preflight)
    const body = new URLSearchParams({
      action:"insert", date, type, recipients, countries, summary
    });

    const res  = await fetch(ENDPOINT, { method:"POST", body });
    const data = await res.json();

    if (data.ok){
      statusEl.innerHTML = `<span class="ok">Saved.</span>`;
      $("n_summary").value = "";
    } else {
      statusEl.innerHTML = `<span class="err">Failed: ${data.error || "Unknown error"}</span>`;
      alert(`Error saving note: ${data.error || "Unknown error"}`);
    }
  } catch(err){
    statusEl.innerHTML = `<span class="err">Error: ${err.message}</span>`;
    alert(`Error saving note: ${err.message}`);
    console.error(err);
  }
}
</script>
</body>
</html>
