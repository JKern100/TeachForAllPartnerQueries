<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Teach For All â€” Knowledge Q&A</title>
  <meta name="description" content="Ask questions against Teach For All meeting data and get AI-powered answers with sources." />
  <style>
    :root { color-scheme: light dark; --bg:#0b0d10; --fg:#e8eaed; --card:#0f1216; --muted:#a8b0b9; --line:#2a2e33; --brand:#5b8cff; --brand-2:#7cc4ff; }
    @media (prefers-color-scheme:light){
      :root{ --bg:#f6f8fb; --fg:#0b0d10; --card:#ffffff; --muted:#5a6675; --line:#e5e8ec; --brand:#0b66ff; --brand-2:#63a2ff;}
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .hero{
      background:linear-gradient(125deg, var(--brand) 0%, var(--brand-2) 100%);
      color:#fff; padding:48px 24px;
    }
    .hero .wrap{max-width:1100px;margin:0 auto}
    .title{font-weight:800;letter-spacing:.2px;margin:0 0 8px}
    .subtitle{opacity:.92;margin:0}
    .build{display:inline-block;margin-left:.5rem;padding:.2rem .6rem;border:1px solid rgba(255,255,255,.35);border-radius:999px;font-size:.8rem;opacity:.95}

    .wrap{max-width:1100px;margin:0 auto;padding:28px 16px}
    .card{background:var(--card); border:1px solid var(--line); border-radius:16px; padding:22px; box-shadow:0 8px 30px rgba(0,0,0,.08)}
    .grid{display:grid; gap:14px}
    .g2{grid-template-columns:1fr 1fr}
    .g3{grid-template-columns:repeat(3,1fr)}
    @media (max-width:900px){ .g2,.g3{grid-template-columns:1fr} }

    label{font-weight:600; font-size:.95rem}
    input,select,textarea,button{
      width:100%; padding:.7rem .8rem; border-radius:12px; border:1px solid var(--line); background:transparent; color:var(--fg);
    }
    textarea{min-height:90px; resize:vertical}
    .hint{font-size:.85rem; color:var(--muted); margin-top:6px}
    .btn{cursor:pointer; background:var(--brand); color:#fff; border-color:transparent; font-weight:700}
    .btn:disabled{opacity:.7; cursor:default}

    .out{margin-top:18px}
    .muted{color:var(--muted)}
    .requrl{font-size:.9rem; white-space:nowrap; overflow:auto; border:1px dashed var(--line); padding:.5rem .6rem; border-radius:10px; background:transparent}
    .sources ul{margin:.5rem 0 0; padding-left:1.25rem}
    .sources li{margin:.25rem 0}

    details{margin-top:.75rem}
    summary{cursor:pointer}
    pre{white-space:pre-wrap; overflow:auto; margin:0}
  </style>
</head>
<body>

  <!-- Header -->
  <section class="hero">
    <div class="wrap">
      <h1 class="title">Teach For All â€” Knowledge Q&A <span id="buildTag" class="build"></span></h1>
      <p class="subtitle">Filter by date, countries, and type; add a topic; ask your question; get an AI-generated answer with sources.</p>
    </div>
  </section>

  <!-- App -->
  <main class="wrap">
    <div class="card">
      <form id="qf" class="grid">
        <!-- 1) From / To / Countries first -->
        <div class="grid g3">
          <div>
            <label for="from">From date</label>
            <input id="from" name="from" type="date" />
          </div>
          <div>
            <label for="to">To date</label>
            <input id="to" name="to" type="date" />
          </div>
          <div>
            <label for="countries">Countries (comma-separated)</label>
            <input id="countries" name="countries" placeholder="Portugal, Spain (leave blank = all)" />
          </div>
        </div>

        <!-- 2) Type selector -->
        <div class="grid g2">
          <div>
            <label for="type">Type</label>
            <select id="type" name="type" title="Limit results to a specific item type">
              <option value="">All (default)</option>
              <option value="Zoom Meeting">Zoom meeting</option>
              <option value="Email">Email</option>
              <option value="Note">Note</option>
            </select>
          </div>

          <!-- 3) Topic -->
          <div>
            <label for="topic">Topic (optional)</label>
            <input id="topic" name="topic" placeholder="standards" />
          </div>
        </div>

        <!-- 4) Question -->
        <div>
          <label for="question">Question</label>
          <textarea id="question" name="question" placeholder="e.g., What are the next steps for network standards?"></textarea>
        </div>

        <!-- 5) Style + Limit + Ask -->
        <div class="grid g3">
          <div>
            <label for="style">Answer style</label>
            <select id="style" name="style">
              <option value="normal">normal</option>
              <option value="short" selected>short</option>
            </select>
          </div>
          <div>
            <label for="limit">Limit</label>
            <input id="limit" name="limit" type="number" min="1" max="10" value="5" />
            <div class="hint">Max number of rows pulled from Supabase as context (keeps responses fast & relevant).</div>
          </div>
          <div style="display:flex; align-items:flex-end">
            <button id="askBtn" class="btn" type="submit">Ask</button>
          </div>
        </div>
      </form>

      <!-- Output -->
      <section class="out">
        <div class="muted" id="filters">Filters â€” none</div>
        <h3 style="margin:.35rem 0 .5rem">Answer</h3>
        <div id="answer">â€”</div>

        <div id="sources" class="sources"></div>

        <details>
          <summary>Debug â€” Request, REST, SQL & Raw JSON</summary>
          <div style="margin:.5rem 0 .25rem;font-weight:600">Request URL</div>
          <div class="requrl" id="reqUrl">â€”</div>

          <div style="margin:.8rem 0 .25rem;font-weight:600">Supabase REST URL</div>
          <div class="requrl" id="restUrl">â€”</div>

          <div style="margin:.8rem 0 .25rem;font-weight:600">SQL (approximate)</div>
          <pre id="sqlText">â€”</pre>

          <div style="margin:.8rem 0 .25rem;font-weight:600">Response JSON</div>
          <pre id="raw"></pre>
        </details>
      </section>
    </div>
  </main>

  <script>
    // ðŸ”— Your current Apps Script endpoint (updated)
    const ENDPOINT = "https://script.google.com/macros/s/AKfycbyvzIgN1uiRtnQh9SkjHo8ADtm66NrX2b1uIWr_vQ6XweQZvu1r9izXIVtPWzF7SuDZ/exec";

    const form = document.getElementById('qf');
    const btn = document.getElementById('askBtn');
    const out = document.getElementById('answer');
    const src = document.getElementById('sources');
    const raw = document.getElementById('raw');
    const filt = document.getElementById('filters');
    const buildTag = document.getElementById('buildTag');
    const reqUrlEl = document.getElementById('reqUrl');
    const restUrlEl = document.getElementById('restUrl');
    const sqlTextEl = document.getElementById('sqlText');

    const esc = s => (s==null ? "" : String(s)
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#39;"));

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      btn.disabled = true;
      out.textContent = "Workingâ€¦";
      src.innerHTML = "";
      raw.textContent = "";
      filt.textContent = "Filters â€” â€¦";
      restUrlEl.textContent = "â€”";
      sqlTextEl.textContent = "â€”";

      const fd = new FormData(form);
      const params = new URLSearchParams();
      ["from","to","countries","type","topic","question","style","limit"].forEach(k=>{
        const v = (fd.get(k) ?? "").toString();
        params.set(k, v);
      });
      params.set("ts", Date.now().toString()); // cache-buster
      const url = `${ENDPOINT}?${params.toString()}`;
      reqUrlEl.textContent = url;

      try {
        const res = await fetch(url);
        const data = await res.json();

        if (data.build) buildTag.textContent = data.build;

        if (data.error) {
          out.innerHTML = `<span class="muted">Error:</span> ${esc(data.error)}`
            + (data.detail ? `<div class="muted">${esc(data.detail)}</div>` : "");
          raw.textContent = JSON.stringify(data, null, 2);
          filt.textContent = "Filters â€” error";
          if (data.debug && data.debug.rest) restUrlEl.textContent = data.debug.rest;
          if (data.debug && data.debug.sql)  sqlTextEl.textContent = data.debug.sql;
          return;
        }

        out.textContent = data.answer || "(no answer)";
        raw.textContent = JSON.stringify(data, null, 2);

        if (data.debug && data.debug.rest) restUrlEl.textContent = data.debug.rest;
        if (data.debug && data.debug.sql)  sqlTextEl.textContent = data.debug.sql;

        if (data.filters) {
          const { from, to, countries, type, topic, limit, style } = data.filters;
          const parts = [];
          if (from) parts.push(`from: ${from}`);
          if (to) parts.push(`to: ${to}`);
          if (countries && countries.length) parts.push(`countries: ${countries.join(", ")}`);
          if (type) parts.push(`type: ${type}`);
          if (topic) parts.push(`topic: ${topic}`);
          parts.push(`limit: ${limit}`);
          if (style) parts.push(`style: ${style}`);
          filt.textContent = parts.length ? "Filters â€” " + parts.join(" | ") : "Filters â€” none";
        } else {
          filt.textContent = "Filters â€” none";
        }

        if (Array.isArray(data.sources) && data.sources.length) {
          const list = data.sources.map(s=>{
            const meta = [s.date, s.type, s.countries].filter(Boolean).join(" Â· ");
            const link = s.url ? ` â€” <a href="${esc(s.url)}" target="_blank" rel="noopener">link</a>` : "";
            return `<li>${esc(s.title || "(untitled)")} ${meta?`<span class="muted">(${esc(meta)})</span>`:""}${link}</li>`;
          }).join("");
          src.innerHTML = `<h4 style="margin:.8rem 0 .3rem">Sources</h4><ul>${list}</ul>`;
        } else {
          src.innerHTML = "";
        }
      } catch (err) {
        out.innerHTML = `<span class="muted">Network error:</span> ${esc(err.message || err)}`;
        filt.textContent = "Filters â€” network error";
      } finally {
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>
